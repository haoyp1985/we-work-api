# WeWork Platform - MySQL 配置文件
# 针对企业级微服务应用优化

[mysqld]

# ================================
# 基础配置
# ================================
port = 3306
socket = /var/run/mysqld/mysqld.sock
pid-file = /var/run/mysqld/mysqld.pid
datadir = /var/lib/mysql
tmpdir = /tmp

# 字符集配置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
init_connect = 'SET NAMES utf8mb4'

# 时区配置
default-time-zone = '+08:00'

# ================================
# 连接配置
# ================================
max_connections = 1000
max_connect_errors = 1000
wait_timeout = 28800
interactive_timeout = 28800
back_log = 600

# 连接超时配置
connect_timeout = 10
net_read_timeout = 30
net_write_timeout = 60

# ================================
# 缓存配置
# ================================
# InnoDB 缓冲池大小 (建议为系统内存的 70-80%)
innodb_buffer_pool_size = 1G
innodb_buffer_pool_instances = 4

# 查询缓存
query_cache_type = 1
query_cache_size = 64M
query_cache_limit = 2M
query_cache_min_res_unit = 2k

# 表缓存
table_open_cache = 2000
table_definition_cache = 1400

# 临时表配置
tmp_table_size = 64M
max_heap_table_size = 64M

# ================================
# InnoDB 配置
# ================================
# InnoDB 数据文件配置
innodb_data_file_path = ibdata1:100M:autoextend
innodb_autoextend_increment = 64

# InnoDB 日志配置
innodb_log_file_size = 256M
innodb_log_files_in_group = 2
innodb_log_buffer_size = 32M

# InnoDB 刷盘策略
innodb_flush_log_at_trx_commit = 1
innodb_flush_method = O_DIRECT
innodb_sync_spin_loops = 40

# InnoDB 锁配置
innodb_lock_wait_timeout = 120
innodb_rollback_on_timeout = ON

# InnoDB 线程配置
innodb_thread_concurrency = 16
innodb_read_io_threads = 8
innodb_write_io_threads = 8
innodb_purge_threads = 4

# InnoDB 页面配置
innodb_page_size = 16384
innodb_io_capacity = 2000
innodb_io_capacity_max = 4000

# ================================
# MyISAM 配置
# ================================
key_buffer_size = 64M
sort_buffer_size = 2M
read_buffer_size = 2M
read_rnd_buffer_size = 8M
myisam_sort_buffer_size = 64M

# ================================
# 日志配置
# ================================
# 错误日志
log-error = /var/log/mysql/error.log

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log_queries_not_using_indexes = 1
log_throttle_queries_not_using_indexes = 10

# 二进制日志
log-bin = /var/log/mysql/mysql-bin
binlog_format = ROW
expire_logs_days = 7
max_binlog_size = 100M
sync_binlog = 1

# 中继日志
relay_log = /var/log/mysql/relay-bin
relay_log_recovery = 1

# ================================
# 复制配置
# ================================
server-id = 1
gtid_mode = ON
enforce_gtid_consistency = ON
log_slave_updates = ON
relay_log_info_repository = TABLE
master_info_repository = TABLE

# ================================
# 性能优化配置
# ================================
# 线程配置
thread_cache_size = 128
thread_stack = 256K

# 排序和分组配置
max_sort_length = 8192
group_concat_max_len = 1024

# 网络缓冲区配置
max_allowed_packet = 64M
net_buffer_length = 32K

# 批量插入优化
bulk_insert_buffer_size = 8M

# ================================
# 安全配置
# ================================
# 禁用本地文件加载
local-infile = 0

# 禁用符号链接
symbolic-links = 0

# 密码验证
validate_password.length = 8
validate_password.mixed_case_count = 1
validate_password.number_count = 1
validate_password.special_char_count = 1

# SQL模式
sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO

# ================================
# 客户端配置
# ================================
[mysql]
default-character-set = utf8mb4
no-auto-rehash

[mysqldump]
quick
max_allowed_packet = 64M

[client]
port = 3306
socket = /var/run/mysqld/mysqld.sock
default-character-set = utf8mb4