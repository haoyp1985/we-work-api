环境
下列机器均使用 Ubuntu 20 或以上（建议ubuntu22)
协议机 1c1g 可以跑100个号，如果平时资源下载比较多，可以上到 2c4g/4c8g，存储无要求（主要存储日志），带宽设置动态或峰值50M（具体看号对图片视频下载的量），入网可以按自身需求调整，出网不限（企微多个微服务，多个IP，微服务地址也会动态调整）
如果需要大量下载资源（文件、图片、语音），那么内存需要相对应去提高。
真实案例：100号+聚合聊天场景，2c4g+动态100M带宽足以。
系统架构
本系统主要有3个服务（进程）
- wework_service 协议服务
- wework_web 主要用于对外暴露接口访问
- bridge 桥接服务，用来解决异地登录的问题（可选）

依赖的外部服务
- redis
- mqtt（可选）
新部署
一、安装 redis
apt install -y redis-server unzip
vim /etc/redis/redis.conf

// 把下面两项的注释去掉， appendonly 改为 yes, requirepass 后面为 redis 密码
# appendonly yes 
# requirepass xxx

service redis-server restart
二、复制软件到服务器
不要擅自修改路径！不要擅自修改路径！不要擅自修改路径！
scp xbot.zip root@xxx:/home
三、解压
cd /home
unzip xbot.zip
四、配置密钥
问作者拿到密钥
vim /home/xbot/wework_service/.work_key
五、配置 wework_web
vim /home/xbot/wework_web/.env

// 之后访问该机器IP+该端口即可
# ADDR=0.0.0.0:23456
六、配置 wework_service
桥接简介
桥接是为了解决异地登录的问题，假如服务器在广州，用户在北京，扫码登录就会遇到异地登录，导致需要人脸识别验证。如果有这种场景，可以使用桥接解决。如果是公司账号都在广州，那么直接购买广州服务器即可，无需部署桥接服务。

桥接的运作原理是使用用户的网络发起登录请求，所以需要客户端和服务端，客户端可以是 EXE、小程序、APP等（网页是不行的，因为浏览器有跨域限制）。目前有提供EXE让用户使用，如果需求不满足也可以根据桥接协议进行开发自身的客户端。

企微桥接（免代理）   密码：12N561#2 
非桥接部署
配置
cd /home/xbot/wework_service
vim config.ini
直接复制下方配置，只需要改动 redis 和 cdn 配置即可
[config]
# 支持配置项 DEBUG, INFO, ERROR, 日志文件路径的 ~/.wwxbot/logs 目录下，每30分钟存一个单独文件， 保留24个
log_level = DEBUG

session_storage = redis

# redis 配置，存储实例信息（一定要设置密码！！！别被黑了！）
redis_host = 127.0.0.1
redis_port = 6379
redis_passwd =
redis_db = 0

# 开启http通知
notify_http_enable = True

# 开启日志
notify_logger_enable = True
notify_http_logger_enable  = True

# 消息批量通知 消息将以List通知 notify_type = 11013
msg_notify_batch_enable = False

# 支持 aliyun 和 tencent， 不使用cdn可以设置 empty
cloud_storage = tencent

# tencent cos config
cos_secret_id = 
cos_secret_key = 
cos_endpoint = https://xxxx.cos.ap-nanjing.myqcloud.com

# aliyun oss config
oss_access_key =
oss_access_key_secret =
oss_endpoint = https://oss-cn-qingdao.aliyuncs.com
#  如果oss与服务器在一个内网可以设置这个
oss_internal_endpoint =
oss_bucket =

# 是否通知好友变动
friend_change_notify_enable = True

# friend notify interval second
friend_change_notify_interval = 0

# 每xx秒内主动去同步下消息
msg_sync_interval = 30

# 是否上报业务数据
report_online_stat_enable = True

# 单位 分钟，多长时间保存一个新文件
log_interval = 30 

# 保存文件数量
log_backup_count = 120
桥接部署
安装mqtt
桥接服务需要跟协议服务进行实时通讯，通讯方式为 mqtt，用到桥接服务均需要安装 mqtt 并加以配置
apt install -y redis mosquitto
Mqtt 配置
vim /etc/mosquitto/conf.d/default.conf

# allow_anonymous true
重启 mqtt
service mosquitto restart
配置
cd /home/xbot/wework_service
vim config.ini
直接复制下方配置，只需要改动 redis 和 cdn 配置即可，mqtt部分可以保持默认
[config]
# 支持配置项 DEBUG, INFO, ERROR, 日志文件路径的 ~/.wwxbot/logs 目录下，每30分钟存一个单独文件， 保留24个
log_level = DEBUG

session_storage = redis

# redis 配置，存储实例信息（一定要设置密码！！！别被黑了！）
redis_host = 127.0.0.1
redis_port = 6379
redis_passwd =
redis_db = 0

# 开启http通知
notify_http_enable = True

# 开启日志
notify_logger_enable = True
notify_http_logger_enable  = True

# 消息批量通知 消息将以List通知 notify_type = 11013
msg_notify_batch_enable = True

# 支持 aliyun 和 tencent， 不使用cdn可以设置 empty
cloud_storage = tencent

# tencent cos config
cos_secret_id = 
cos_secret_key = 
cos_endpoint = https://xxxx.cos.ap-nanjing.myqcloud.com

# aliyun oss config
oss_access_key =
oss_access_key_secret =
oss_endpoint = https://oss-cn-qingdao.aliyuncs.com
#  如果oss与服务器在一个内网可以设置这个
oss_internal_endpoint =
oss_bucket =

# bridge 桥接，详情看桥接文档
bridge_enable = True
bridge_redis_host = 127.0.0.1
bridge_redis_port = 6379
bridge_redis_passwd =
bridge_redis_db = 2

# 可以默认不用动
bridge_mqtt_host = 127.0.0.1
bridge_mqtt_port = 1883
bridge_mqtt_username =
bridge_mqtt_passwd =
# v31=3, v311=4, v5=5
bridge_mqtt_protocol = 4

# bridge namespace
bridge_mqtt_namespace = /xbot/bridge/notify
bridge_redis_namespace = xbot.bridge

# 是否通知好友变动
friend_change_notify_enable = True

# friend notify interval second
friend_change_notify_interval = 0

# 每xx秒内主动去同步下消息
msg_sync_interval = 30

# 是否上报业务数据
report_online_stat_enable = True

# 单位 分钟，多长时间保存一个新文件
log_interval = 30 

# 保存文件数量
log_backup_count = 120
解压 bridge
把bridge.zip解压到 /home/bridge 目录
配置 bridge
这是桥接服务的配置
vim /home/bridge/bridge/config.ini
配置与 wework_service 是一一对应的关系，这样才能互相通讯，用户可以选择修改 web_port 的 ws 访问端口
[config]

# redis
redis_host = 127.0.0.1
redis_port = 6379
redis_passwd =
redis_db = 2

# mqtt
mqtt_host = 127.0.0.1
mqtt_port = 1883
mqtt_username =
mqtt_passwd =
# v31=3, v311=4, v5=5
mqtt_protocol_version = 4

# bridge namespace
bridge_mqtt_namespace = /xbot/bridge/notify
bridge_redis_namespace = xbot.bridge

# websocket
web_host = 0.0.0.0
web_port = 33789
七、运行服务
服务运行从 supervisor 和脚本中二选一，桥接部署了才能运行桥接服务。
Supervisor 运行
配置
apt install supervisor

vim /etc/supervisor/conf.d/wework_web.conf
vim /etc/supervisor/conf.d/wework_service.conf
vim /etc/supervisor/conf.d/wework_restore.conf

vim /etc/supervisor/conf.d/bridge.conf

// 分别放下面内容
wework_web.conf
[program:wework_web]
process_name=wework_web
directory=/home/xbot/wework_web/
command=/home/xbot/wework_web/wework_web
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
startretries=3
wework_service.conf
[program:wework_service]
process_name=wework_service
directory=/home/xbot/wework_service/
command=/home/xbot/wework_service/wework_service
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
startretries=3
wework_restore.conf
[program:wework_restore]
process_name=wework_restore
command=/home/xbot/restore.sh
autostart=true
autorestart=false
startsecs=0
bridge.conf
[program:bridge]
process_name=bridge
directory=/home/bridge/bridge/
command=/home/bridge/bridge/bridge
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
startretries=3
运行
// 给执行权限
chmod +x /home/xbot/wework_web/wework_web /home/xbot/wework_service/wework_service /home/bridge/bridge/bridge /home/xbot/restore /home/xbot/wework_service/libs/linux/ffmpeg/ffmpeg /home/xbot/wework_service/libs/linux/ffmpeg/ffprobe

// 更新 supervisor 任务
supervisorctl update
脚本运行
cd /home/xbot

sh restart_wework.sh
运行桥接服务（桥接模式）
cd /home/bridge
sh restart.sh

crontab -e
// 目前桥接有内存泄露问题，定时重启可解决
# 0 0 * * * cd /home/bridge/ && sh restart.sh
八、确认是否正常运行
ps -ef | grep we
执行后能看到 wework_service wework_web bridge（可选），则证明已正常运行
[图片]
异常排查
假如发现某个服务没有执行，大概率是配置问题，如 redis 连不上，mqtt连不上等等。具体可以直接运行对应服务查看输出的错误
例如 wework_service 没起来
cd /home/xbot/wework_service
./wework_service
根据输出的报错调整即可
八、开启防火墙
wework_web 里面配置的端口以及 bridge 配置的端口需要在防火墙里对外开启
九、备份配置
配置一旦因意外丢失或被覆盖，重新整理会很麻烦，影响业务，建议备份一次
cp /home/xbot/wework_service/config.ini /home/xbot/wework_service/config.ini.backup
十、其他回调方式（可选）
之前的配置是使用 HTTP 方式进行回调，除此之外还支持其他回调方式，可共存，不互斥。客户端对接方式自行网上搜索。
cd /home/xbot/wework_service
vim config.ini
以下配置都在这个文件内
MQTT
# mqtt notify
notify_mqtt_enable = True
notify_mqtt_host = 127.0.0.1
notify_mqtt_port = 1883
notify_mqtt_username =
notify_mqtt_passwd =
# v31=3, v311=4, v5=5
notify_mqtt_protocol = 4
notify_mqtt_topic = /xbot/notify

# notify message mqtt
notify_msg_mqtt_enable = True
notify_msg_mqtt_host = 127.0.0.1
notify_msg_mqtt_port = 1883
notify_msg_mqtt_username =
notify_msg_mqtt_passwd =
# v31=3, v311=4, v5=5
notify_msg_mqtt_protocol = 4
notify_msg_mqtt_topic =  /xbot/notify
REDIS
notify_redis_logger_enable = True
notify_redis_enable = True
notify_redis_host = 127.0.0.1
notify_redis_port = 6379
notify_redis_passwd =
notify_redis_channel = wework:notify
更新版本
一、复制软件到服务器
scp xbot.zip root@xxx:/home
二、更新
Supervisor 重启
supervisorctl stop wework_service
supervisorctl stop wework_web
cd /home
unzip -o xbot.zip

chmod +x /home/xbot/wework_web/wework_web /home/xbot/wework_service/wework_service /home/bridge/bridge/bridge /home/xbot/restore /home/xbot/wework_service/libs/linux/ffmpeg/ffmpeg /home/xbot/wework_service/libs/linux/ffmpeg/ffprobe
supervisorctl start wework_service
supervisorctl start wework_web

// 延迟几秒运行，不然可能 wework_service 还没起来
/home/xbot/restore
脚本重启
cd /home/xbot
sh stop_wework.sh
cd /home
unzip -o xbot.zip
cd xbot
sh restart_wework.sh
问题排查
有任何问题都可以通过日志排查，协议的日志路径为 ~/.wwxbot/logs ，web 请求的日志路径为 /home/xbot/logs
