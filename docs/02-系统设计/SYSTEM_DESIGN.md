# ğŸ¢ ä¼ä¸šå¾®ä¿¡ç®¡ç†ç³»ç»Ÿè®¾è®¡æ–‡æ¡£
*ç”Ÿäº§çº§ä¼å¾®è´¦å·ä¸æ¶ˆæ¯ç®¡ç†å¹³å°*

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒæ¨¡å—è®¾è®¡](#æ ¸å¿ƒæ¨¡å—è®¾è®¡)
4. [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
5. [APIè®¾è®¡](#apiè®¾è®¡)
6. [ç›‘æ§å‘Šè­¦ç³»ç»Ÿ](#ç›‘æ§å‘Šè­¦ç³»ç»Ÿ)
7. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
8. [å®‰å…¨è®¾è®¡](#å®‰å…¨è®¾è®¡)
9. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

### ä¸šåŠ¡ç›®æ ‡
- **ä¼å¾®è´¦å·å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šåˆ›å»ºã€ç™»å½•ã€ç›‘æ§ã€ä¸‹çº¿
- **é«˜å¹¶å‘æ¶ˆæ¯å¤„ç†**ï¼šæ”¯æŒå•æ—¥åƒä¸‡çº§æ¶ˆæ¯å‘é€
- **å®æ—¶ç›‘æ§å‘Šè­¦**ï¼šè´¦å·çŠ¶æ€ã€æ¶ˆæ¯çŠ¶æ€ã€ç³»ç»Ÿå¥åº·åº¦
- **å¤šç§Ÿæˆ·éš”ç¦»**ï¼šæ”¯æŒå¤šä¸ªä¸šåŠ¡æ–¹ç‹¬ç«‹ä½¿ç”¨

### æ ¸å¿ƒç‰¹æ€§
- ğŸ”„ **è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šè´¦å·è‡ªåŠ¨ç™»å½•ã€å¼‚å¸¸è‡ªæ„ˆ
- ğŸ“Š **å®æ—¶ç›‘æ§**ï¼šå…¨é“¾è·¯ç›‘æ§å’Œå¯è§†åŒ–
- ğŸš€ **é«˜å¯ç”¨è®¾è®¡**ï¼šæœåŠ¡æ— å•ç‚¹æ•…éšœ
- ğŸ”’ **å®‰å…¨å¯é **ï¼šæ•°æ®åŠ å¯†ã€æƒé™æ§åˆ¶
- ğŸ“ˆ **å¼¹æ€§æ‰©å±•**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾
*(å·²åœ¨ä¸Šæ–¹å±•ç¤º)*

### æ¶æ„åˆ†å±‚è¯´æ˜

#### 1. å‰ç«¯å±‚
- **Webç®¡ç†ç•Œé¢**ï¼šè´¦å·ç®¡ç†ã€æ¶ˆæ¯å‘é€ã€ç›‘æ§æŸ¥çœ‹
- **APIå®¢æˆ·ç«¯**ï¼šç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆæ¥å£
- **ç›‘æ§é¢æ¿**ï¼šå®æ—¶ç›‘æ§æ•°æ®å±•ç¤º

#### 2. APIç½‘å…³å±‚
- **APIç½‘å…³**ï¼šç»Ÿä¸€å…¥å£ã€è·¯ç”±åˆ†å‘
- **è®¤è¯ä¸­å¿ƒ**ï¼šJWTè®¤è¯ã€æƒé™æ§åˆ¶
- **é™æµæ§åˆ¶**ï¼šé˜²åˆ·ã€é™æµã€ç†”æ–­

#### 3. ä¸šåŠ¡æœåŠ¡å±‚
- **è´¦å·ç®¡ç†æœåŠ¡**ï¼šä¼å¾®è´¦å·CRUDã€çŠ¶æ€ç®¡ç†
- **æ¶ˆæ¯æœåŠ¡**ï¼šæ¶ˆæ¯å‘é€ã€æ¨¡æ¿ç®¡ç†ã€é˜Ÿåˆ—å¤„ç†
- **ç›‘æ§æœåŠ¡**ï¼šæŒ‡æ ‡æ”¶é›†ã€å‘Šè­¦å¤„ç†
- **å›è°ƒå¤„ç†æœåŠ¡**ï¼šä¼å¾®å›è°ƒç»Ÿä¸€å¤„ç†
- **è°ƒåº¦æœåŠ¡**ï¼šå®šæ—¶ä»»åŠ¡ã€æ‰¹é‡æ“ä½œ

#### 4. æ•°æ®å­˜å‚¨å±‚
- **MySQL**ï¼šä¸šåŠ¡ä¸»æ•°æ®
- **Redis**ï¼šç¼“å­˜ã€ä¼šè¯ã€æ¶ˆæ¯é˜Ÿåˆ—
- **InfluxDB**ï¼šæ—¶åºç›‘æ§æ•°æ®
- **æ–‡ä»¶å­˜å‚¨**ï¼šæ—¥å¿—ã€æ–‡ä»¶ã€å›¾ç‰‡

#### 5. åŸºç¡€è®¾æ–½å±‚
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¼‚æ­¥å¤„ç†ã€å‰Šå³°å¡«è°·
- **æ—¥å¿—ä¸­å¿ƒ**ï¼šç»Ÿä¸€æ—¥å¿—æ”¶é›†åˆ†æ
- **å‘Šè­¦ç³»ç»Ÿ**ï¼šå¤šæ¸ é“å‘Šè­¦é€šçŸ¥
- **é…ç½®ä¸­å¿ƒ**ï¼šç»Ÿä¸€é…ç½®ç®¡ç†

## ğŸ§© æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. è´¦å·ç®¡ç†æœåŠ¡ (Account Service)

#### åŠŸèƒ½èŒè´£
```yaml
è´¦å·ç”Ÿå‘½å‘¨æœŸç®¡ç†:
  - è´¦å·æ³¨å†Œä¸é…ç½®
  - è‡ªåŠ¨ç™»å½•ç®¡ç†
  - çŠ¶æ€ç›‘æ§ä¸æ¢å¤
  - è´¦å·ä¸‹çº¿ä¸æ¸…ç†

æ ¸å¿ƒæ¥å£:
  - POST /accounts              # åˆ›å»ºè´¦å·
  - GET /accounts/{id}          # è·å–è´¦å·è¯¦æƒ…
  - PUT /accounts/{id}/login    # ç™»å½•è´¦å·
  - PUT /accounts/{id}/logout   # ç™»å‡ºè´¦å·
  - GET /accounts/{id}/status   # è·å–çŠ¶æ€
  - DELETE /accounts/{id}       # åˆ é™¤è´¦å·
```

#### çŠ¶æ€æœºè®¾è®¡
```mermaid
stateDiagram-v2
    [*] --> å·²åˆ›å»º
    å·²åˆ›å»º --> ç™»å½•ä¸­ : å¼€å§‹ç™»å½•
    ç™»å½•ä¸­ --> ç­‰å¾…æ‰«ç  : è·å–äºŒç»´ç 
    ç­‰å¾…æ‰«ç  --> ç­‰å¾…ç¡®è®¤ : ç”¨æˆ·æ‰«ç 
    ç­‰å¾…ç¡®è®¤ --> éœ€è¦éªŒè¯ : æ–°è®¾å¤‡
    éœ€è¦éªŒè¯ --> å·²ç™»å½• : éªŒè¯é€šè¿‡
    ç­‰å¾…ç¡®è®¤ --> å·²ç™»å½• : ç¡®è®¤ç™»å½•
    å·²ç™»å½• --> å¼‚å¸¸ : ç½‘ç»œ/æœåŠ¡å¼‚å¸¸
    å¼‚å¸¸ --> æ¢å¤ä¸­ : è‡ªåŠ¨æ¢å¤
    æ¢å¤ä¸­ --> å·²ç™»å½• : æ¢å¤æˆåŠŸ
    æ¢å¤ä¸­ --> å·²ç¦»çº¿ : æ¢å¤å¤±è´¥
    å·²ç™»å½• --> å·²ç¦»çº¿ : ä¸»åŠ¨ä¸‹çº¿
    å·²ç¦»çº¿ --> ç™»å½•ä¸­ : é‡æ–°ç™»å½•
    å·²ç¦»çº¿ --> [*] : åˆ é™¤è´¦å·
```

#### æ ¸å¿ƒé€»è¾‘å®ç°
```python
class AccountService:
    async def create_account(self, account_data: AccountCreateDTO) -> Account:
        """åˆ›å»ºä¼å¾®è´¦å·"""
        # 1. æ•°æ®éªŒè¯
        # 2. åˆ›å»ºå®ä¾‹
        # 3. åˆå§‹åŒ–é…ç½®
        # 4. ä¿å­˜æ•°æ®åº“
        # 5. å‘é€åˆ›å»ºäº‹ä»¶
        
    async def login_account(self, account_id: str) -> LoginResult:
        """è´¦å·ç™»å½•æµç¨‹"""
        # 1. æ£€æŸ¥è´¦å·çŠ¶æ€
        # 2. åˆ›å»ºä¼å¾®å®ä¾‹
        # 3. è®¾ç½®å›è°ƒåœ°å€
        # 4. è·å–ç™»å½•äºŒç»´ç 
        # 5. å¯åŠ¨çŠ¶æ€ç›‘æ§
        
    async def monitor_account_status(self, account_id: str):
        """è´¦å·çŠ¶æ€ç›‘æ§"""
        # 1. å®šæ—¶æ£€æŸ¥å®ä¾‹çŠ¶æ€
        # 2. æ£€æµ‹å¼‚å¸¸è‡ªåŠ¨æ¢å¤
        # 3. è®°å½•çŠ¶æ€å˜æ›´æ—¥å¿—
        # 4. è§¦å‘å‘Šè­¦é€šçŸ¥
```

### 2. æ¶ˆæ¯æœåŠ¡ (Message Service)

#### åŠŸèƒ½èŒè´£
```yaml
æ¶ˆæ¯å‘é€ç®¡ç†:
  - å•æ¡/æ‰¹é‡æ¶ˆæ¯å‘é€
  - æ¶ˆæ¯æ¨¡æ¿ç®¡ç†
  - å‘é€é˜Ÿåˆ—ç®¡ç†
  - å‘é€ç»“æœè·Ÿè¸ª

æ¶ˆæ¯ç±»å‹æ”¯æŒ:
  - æ–‡æœ¬æ¶ˆæ¯
  - å›¾ç‰‡æ¶ˆæ¯
  - æ–‡ä»¶æ¶ˆæ¯
  - ç¾¤@æ¶ˆæ¯
  - å°ç¨‹åºå¡ç‰‡
```

#### æ¶ˆæ¯å‘é€æµç¨‹
```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant API as æ¶ˆæ¯API
    participant Queue as æ¶ˆæ¯é˜Ÿåˆ—
    participant Worker as æ¶ˆæ¯Worker
    participant WeWork as ä¼å¾®API
    participant Callback as å›è°ƒæœåŠ¡

    Client->>API: å‘é€æ¶ˆæ¯è¯·æ±‚
    API->>API: å‚æ•°éªŒè¯
    API->>Queue: å…¥é˜Ÿæ¶ˆæ¯
    API->>Client: è¿”å›æ¶ˆæ¯ID
    
    Queue->>Worker: æ¶ˆè´¹æ¶ˆæ¯
    Worker->>WeWork: è°ƒç”¨ä¼å¾®API
    WeWork->>Worker: è¿”å›å‘é€ç»“æœ
    Worker->>Callback: æ›´æ–°æ¶ˆæ¯çŠ¶æ€
    
    WeWork->>Callback: æ¶ˆæ¯åŒæ­¥å›è°ƒ
    Callback->>Client: Webhooké€šçŸ¥(å¯é€‰)
```

#### æ ¸å¿ƒæ•°æ®ç»“æ„
```python
@dataclass
class MessageRequest:
    """æ¶ˆæ¯å‘é€è¯·æ±‚"""
    account_id: str          # å‘é€è´¦å·ID
    conversation_id: str     # ä¼šè¯ID
    message_type: str        # æ¶ˆæ¯ç±»å‹
    content: dict           # æ¶ˆæ¯å†…å®¹
    send_time: datetime     # å‘é€æ—¶é—´(å¯é€‰)
    callback_url: str       # å›è°ƒåœ°å€(å¯é€‰)
    
@dataclass 
class MessageRecord:
    """æ¶ˆæ¯è®°å½•"""
    message_id: str         # æ¶ˆæ¯ID
    request: MessageRequest # åŸå§‹è¯·æ±‚
    status: str            # å‘é€çŠ¶æ€
    wework_msg_id: str     # ä¼å¾®æ¶ˆæ¯ID
    send_time: datetime    # å®é™…å‘é€æ—¶é—´
    callback_time: datetime # å›è°ƒæ—¶é—´
    error_msg: str         # é”™è¯¯ä¿¡æ¯
```

### 3. ç›‘æ§æœåŠ¡ (Monitor Service)

#### ç›‘æ§æŒ‡æ ‡ä½“ç³»
```yaml
ç³»ç»Ÿçº§æŒ‡æ ‡:
  - æœåŠ¡å¯ç”¨æ€§ (SLA)
  - å“åº”æ—¶é—´ (RT)
  - é”™è¯¯ç‡ (Error Rate)
  - å¹¶å‘é‡ (QPS/TPS)

ä¸šåŠ¡çº§æŒ‡æ ‡:
  - è´¦å·åœ¨çº¿ç‡
  - æ¶ˆæ¯å‘é€æˆåŠŸç‡
  - æ¶ˆæ¯å‘é€å»¶è¿Ÿ
  - å›è°ƒæ¥æ”¶åŠæ—¶æ€§

å‘Šè­¦è§„åˆ™:
  - è´¦å·ç¦»çº¿ > 5åˆ†é’Ÿ
  - æ¶ˆæ¯å¤±è´¥ç‡ > 1%
  - ç³»ç»Ÿå“åº”æ—¶é—´ > 2s
  - é˜Ÿåˆ—ç§¯å‹ > 1000æ¡
```

#### ç›‘æ§æ¶æ„
```python
class MonitorService:
    async def collect_metrics(self):
        """æŒ‡æ ‡æ”¶é›†"""
        # 1. ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
        # 2. ä¸šåŠ¡çŠ¶æ€æŒ‡æ ‡  
        # 3. è‡ªå®šä¹‰æŒ‡æ ‡
        # 4. å­˜å‚¨åˆ°InfluxDB
        
    async def check_alerts(self):
        """å‘Šè­¦æ£€æŸ¥"""
        # 1. è¯»å–å‘Šè­¦è§„åˆ™
        # 2. æ£€æŸ¥æŒ‡æ ‡é˜ˆå€¼
        # 3. è§¦å‘å‘Šè­¦é€šçŸ¥
        # 4. è®°å½•å‘Šè­¦å†å²
        
    async def generate_reports(self):
        """æŠ¥è¡¨ç”Ÿæˆ"""
        # 1. æ—¥æŠ¥/å‘¨æŠ¥/æœˆæŠ¥
        # 2. è¶‹åŠ¿åˆ†æ
        # 3. å¼‚å¸¸ç»Ÿè®¡
        # 4. æ€§èƒ½åˆ†æ
```

### 4. å›è°ƒå¤„ç†æœåŠ¡ (Callback Service)

#### å›è°ƒç±»å‹å¤„ç†
```python
class CallbackHandler:
    """å›è°ƒå¤„ç†å™¨åŸºç±»"""
    
    @abstractmethod
    async def handle(self, callback_data: dict) -> bool:
        pass

class QRCodeCallbackHandler(CallbackHandler):
    """äºŒç»´ç çŠ¶æ€å›è°ƒå¤„ç†å™¨"""
    async def handle(self, data: dict) -> bool:
        # æ›´æ–°è´¦å·ç™»å½•çŠ¶æ€
        # ä¿å­˜äºŒç»´ç çŠ¶æ€å†å²
        # é€šçŸ¥å‰ç«¯æ›´æ–°
        
class MessageSyncCallbackHandler(CallbackHandler):
    """æ¶ˆæ¯åŒæ­¥å›è°ƒå¤„ç†å™¨"""  
    async def handle(self, data: dict) -> bool:
        # æ›´æ–°æ¶ˆæ¯å‘é€çŠ¶æ€
        # è®°å½•æ¶ˆæ¯æ”¶å‘æ—¥å¿—
        # è§¦å‘ä¸šåŠ¡å›è°ƒ
        
class LoginCallbackHandler(CallbackHandler):
    """ç™»å½•çŠ¶æ€å›è°ƒå¤„ç†å™¨"""
    async def handle(self, data: dict) -> bool:
        # æ›´æ–°è´¦å·åœ¨çº¿çŠ¶æ€
        # è·å–è´¦å·åŸºæœ¬ä¿¡æ¯
        # å¯åŠ¨å®šæ—¶ç›‘æ§ä»»åŠ¡
```

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. è´¦å·ç®¡ç†è¡¨
```sql
-- ä¼å¾®è´¦å·è¡¨
CREATE TABLE wework_accounts (
    id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,        -- ç§Ÿæˆ·ID
    account_name VARCHAR(100) NOT NULL,    -- è´¦å·åç§°
    guid VARCHAR(100) UNIQUE,              -- ä¼å¾®å®ä¾‹GUID
    phone VARCHAR(20),                     -- ç»‘å®šæ‰‹æœºå·
    status ENUM('created', 'logging', 'online', 'offline', 'error') NOT NULL,
    config JSON,                           -- è´¦å·é…ç½®
    last_login_time TIMESTAMP,            -- æœ€åç™»å½•æ—¶é—´
    last_heartbeat_time TIMESTAMP,        -- æœ€åå¿ƒè·³æ—¶é—´
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant_status (tenant_id, status),
    INDEX idx_guid (guid),
    INDEX idx_status_heartbeat (status, last_heartbeat_time)
);

-- è´¦å·çŠ¶æ€å†å²è¡¨
CREATE TABLE account_status_history (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    account_id VARCHAR(36) NOT NULL,
    old_status VARCHAR(20),
    new_status VARCHAR(20) NOT NULL,
    reason VARCHAR(500),
    extra_data JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_account_time (account_id, created_at)
);
```

#### 2. æ¶ˆæ¯ç®¡ç†è¡¨
```sql
-- æ¶ˆæ¯è®°å½•è¡¨
CREATE TABLE message_records (
    id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    account_id VARCHAR(36) NOT NULL,
    conversation_id VARCHAR(100) NOT NULL,
    message_type ENUM('text', 'image', 'file', 'at', 'miniprogram') NOT NULL,
    content JSON NOT NULL,
    status ENUM('pending', 'sending', 'sent', 'delivered', 'failed') NOT NULL,
    wework_msg_id VARCHAR(100),
    error_msg TEXT,
    send_time TIMESTAMP,
    callback_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant_account (tenant_id, account_id),
    INDEX idx_status_time (status, created_at),
    INDEX idx_conversation (conversation_id, created_at)
);

-- æ¶ˆæ¯æ¨¡æ¿è¡¨
CREATE TABLE message_templates (
    id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    template_name VARCHAR(100) NOT NULL,
    template_type VARCHAR(50) NOT NULL,
    template_content JSON NOT NULL,
    variables JSON,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_tenant_name (tenant_id, template_name)
);
```

#### 3. ä¼šè¯ç®¡ç†è¡¨
```sql
-- ä¼šè¯ä¿¡æ¯è¡¨
CREATE TABLE conversations (
    id VARCHAR(36) PRIMARY KEY,
    account_id VARCHAR(36) NOT NULL,
    conversation_id VARCHAR(100) NOT NULL,
    conversation_name VARCHAR(200),
    conversation_type ENUM('private', 'group') NOT NULL,
    member_count INT DEFAULT 0,
    last_msg_time TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    extra_info JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_account_conversation (account_id, conversation_id),
    INDEX idx_account_type (account_id, conversation_type)
);
```

#### 4. ç§Ÿæˆ·ç®¡ç†è¡¨
```sql
-- ç§Ÿæˆ·è¡¨
CREATE TABLE tenants (
    id VARCHAR(36) PRIMARY KEY,
    tenant_name VARCHAR(100) NOT NULL,
    tenant_code VARCHAR(50) UNIQUE NOT NULL,
    max_accounts INT DEFAULT 10,
    max_daily_messages INT DEFAULT 10000,
    webhook_url VARCHAR(500),
    config JSON,
    status ENUM('active', 'suspended', 'deleted') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- ç§Ÿæˆ·é…é¢ä½¿ç”¨è®°å½•
CREATE TABLE tenant_usage (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    usage_date DATE NOT NULL,
    account_count INT DEFAULT 0,
    message_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_tenant_date (tenant_id, usage_date)
);
```

## ğŸ”Œ APIè®¾è®¡

### 1. è´¦å·ç®¡ç†API

```yaml
# åˆ›å»ºè´¦å·
POST /api/v1/accounts
Request:
  tenant_id: string
  account_name: string
  phone: string (optional)
  config: object (optional)
Response:
  account_id: string
  status: string
  
# è·å–è´¦å·åˆ—è¡¨
GET /api/v1/accounts?tenant_id={}&status={}&page={}&size={}
Response:
  accounts: array
  total: number
  page: number
  size: number

# è´¦å·ç™»å½•
PUT /api/v1/accounts/{account_id}/login
Response:
  qrcode_url: string
  login_token: string
  
# è·å–è´¦å·çŠ¶æ€  
GET /api/v1/accounts/{account_id}/status
Response:
  account_id: string
  status: string
  last_heartbeat: timestamp
  online_duration: number
```

### 2. æ¶ˆæ¯å‘é€API

```yaml
# å‘é€å•æ¡æ¶ˆæ¯
POST /api/v1/messages/send
Request:
  account_id: string
  conversation_id: string
  message_type: string
  content: object
  send_time: timestamp (optional)
Response:
  message_id: string
  status: string
  
# æ‰¹é‡å‘é€æ¶ˆæ¯
POST /api/v1/messages/batch-send
Request:
  account_id: string
  messages: array
Response:
  batch_id: string
  total_count: number
  success_count: number
  
# è·å–æ¶ˆæ¯çŠ¶æ€
GET /api/v1/messages/{message_id}/status
Response:
  message_id: string
  status: string
  send_time: timestamp
  error_msg: string (optional)

# è·å–ä¼šè¯åˆ—è¡¨
GET /api/v1/accounts/{account_id}/conversations
Response:
  conversations: array
  total: number
```

### 3. ç›‘æ§API

```yaml
# è·å–è´¦å·ç›‘æ§æ•°æ®
GET /api/v1/monitor/accounts/{account_id}/metrics?start_time={}&end_time={}
Response:
  metrics: array
  
# è·å–æ¶ˆæ¯å‘é€ç»Ÿè®¡
GET /api/v1/monitor/messages/stats?tenant_id={}&start_time={}&end_time={}
Response:
  total_count: number
  success_count: number
  success_rate: number
  avg_response_time: number
  
# è·å–ç³»ç»Ÿå¥åº·çŠ¶æ€
GET /api/v1/monitor/health
Response:
  status: string
  services: array
  uptime: number
```

## ğŸ“Š ç›‘æ§å‘Šè­¦ç³»ç»Ÿ

### ç›‘æ§æŒ‡æ ‡ä½“ç³»

#### 1. åŸºç¡€è®¾æ–½ç›‘æ§
```yaml
æœåŠ¡å™¨èµ„æº:
  - CPUä½¿ç”¨ç‡ < 80%
  - å†…å­˜ä½¿ç”¨ç‡ < 85%
  - ç£ç›˜ä½¿ç”¨ç‡ < 90%
  - ç½‘ç»œè¿æ¥æ•° < 1000

æ•°æ®åº“ç›‘æ§:
  - è¿æ¥æ± ä½¿ç”¨ç‡ < 80%
  - æ…¢æŸ¥è¯¢ < 2s
  - æ­»é”æ£€æµ‹
  - ä¸»ä»å»¶è¿Ÿ < 1s

ç¼“å­˜ç›‘æ§:
  - Rediså†…å­˜ä½¿ç”¨ç‡ < 80%
  - ç¼“å­˜å‘½ä¸­ç‡ > 95%
  - è¿æ¥æ•°ç›‘æ§
```

#### 2. åº”ç”¨å±‚ç›‘æ§
```yaml
APIæ€§èƒ½:
  - å“åº”æ—¶é—´ P99 < 2s
  - é”™è¯¯ç‡ < 1%
  - QPSç›‘æ§
  - æ¥å£å¯ç”¨æ€§ > 99.9%

é˜Ÿåˆ—ç›‘æ§:
  - é˜Ÿåˆ—é•¿åº¦ < 1000
  - æ¶ˆè´¹å»¶è¿Ÿ < 30s
  - æ­»ä¿¡é˜Ÿåˆ—ç›‘æ§
  - æ¶ˆè´¹è€…å¥åº·çŠ¶æ€
```

#### 3. ä¸šåŠ¡ç›‘æ§
```yaml
è´¦å·ç›‘æ§:
  - è´¦å·åœ¨çº¿ç‡ > 95%
  - ç™»å½•æˆåŠŸç‡ > 98%
  - å¼‚å¸¸æ¢å¤æ—¶é—´ < 5min

æ¶ˆæ¯ç›‘æ§:
  - æ¶ˆæ¯å‘é€æˆåŠŸç‡ > 99%
  - æ¶ˆæ¯å‘é€å»¶è¿Ÿ < 10s
  - å›è°ƒæ¥æ”¶ç‡ > 95%
  - é˜Ÿåˆ—ç§¯å‹ç›‘æ§
```

### å‘Šè­¦é…ç½®

#### å‘Šè­¦è§„åˆ™å¼•æ“
```python
class AlertRule:
    def __init__(self, name: str, metric: str, operator: str, 
                 threshold: float, duration: int):
        self.name = name
        self.metric = metric
        self.operator = operator  # >, <, >=, <=, ==
        self.threshold = threshold
        self.duration = duration  # æŒç»­æ—¶é—´(ç§’)
        
# å‘Šè­¦è§„åˆ™é…ç½®
alert_rules = [
    AlertRule("è´¦å·ç¦»çº¿å‘Šè­¦", "account.offline_duration", ">", 300, 60),
    AlertRule("æ¶ˆæ¯å¤±è´¥ç‡å‘Šè­¦", "message.failure_rate", ">", 0.01, 120),
    AlertRule("APIå“åº”æ—¶é—´å‘Šè­¦", "api.response_time", ">", 2000, 180),
    AlertRule("é˜Ÿåˆ—ç§¯å‹å‘Šè­¦", "queue.pending_count", ">", 1000, 60),
]
```

#### å‘Šè­¦é€šçŸ¥æ¸ é“
```yaml
é€šçŸ¥æ–¹å¼:
  - ä¼å¾®ç¾¤æ¶ˆæ¯
  - é‚®ä»¶é€šçŸ¥
  - çŸ­ä¿¡å‘Šè­¦
  - é’‰é’‰æœºå™¨äºº
  - Webhookæ¨é€

å‘Šè­¦çº§åˆ«:
  - Critical: ç«‹å³é€šçŸ¥æ‰€æœ‰æ¸ é“
  - Warning: ä¼å¾®+é‚®ä»¶
  - Info: ä»…ä¼å¾®ç¾¤æ¶ˆæ¯

å‘Šè­¦æŠ‘åˆ¶:
  - ç›¸åŒå‘Šè­¦5åˆ†é’Ÿå†…ä¸é‡å¤
  - æ‰¹é‡å‘Šè­¦åˆå¹¶å‘é€
  - é™é»˜æ—¶é—´æ®µé…ç½®
```

## ğŸš€ éƒ¨ç½²æ¶æ„

### 1. å¾®æœåŠ¡éƒ¨ç½²æ¶æ„

```yaml
æœåŠ¡æ‹†åˆ†:
  gateway-service:
    instances: 2
    resources: "1C2G"
    
  account-service:
    instances: 3
    resources: "2C4G"
    
  message-service:
    instances: 5  # æ¶ˆæ¯å¤„ç†å‹åŠ›å¤§
    resources: "2C4G"
    
  monitor-service:
    instances: 2
    resources: "1C2G"
    
  callback-service:
    instances: 3
    resources: "2C4G"

æ•°æ®åº“:
  mysql-master: "4C8G"
  mysql-slave: "4C8G"  
  redis-cluster: 3èŠ‚ç‚¹ "2C4G"
  influxdb: "2C4G"

æ¶ˆæ¯é˜Ÿåˆ—:
  rabbitmq-cluster: 3èŠ‚ç‚¹ "2C4G"
```

### 2. å®¹å™¨åŒ–éƒ¨ç½²

#### Docker Composeç¤ºä¾‹
```yaml
version: '3.8'
services:
  # APIç½‘å…³
  gateway:
    image: wework-gateway:latest
    ports:
      - "80:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
    depends_on:
      - redis
      - mysql

  # è´¦å·ç®¡ç†æœåŠ¡
  account-service:
    image: wework-account:latest
    environment:
      - SPRING_PROFILES_ACTIVE=prod
    depends_on:
      - mysql
      - redis
    deploy:
      replicas: 3

  # æ¶ˆæ¯æœåŠ¡
  message-service:
    image: wework-message:latest
    environment:
      - SPRING_PROFILES_ACTIVE=prod
    depends_on:
      - mysql
      - redis
      - rabbitmq
    deploy:
      replicas: 5

  # æ•°æ®åº“
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql

  # ç¼“å­˜
  redis:
    image: redis:7
    volumes:
      - redis_data:/data

  # æ¶ˆæ¯é˜Ÿåˆ—
  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS}

volumes:
  mysql_data:
  redis_data:
```

### 3. Kuberneteséƒ¨ç½²

#### æœåŠ¡éƒ¨ç½²ç¤ºä¾‹
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: account-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: account-service
  template:
    metadata:
      labels:
        app: account-service
    spec:
      containers:
      - name: account-service
        image: wework-account:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "k8s"
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: account-service
spec:
  selector:
    app: account-service
  ports:
  - port: 8080
    targetPort: 8080
  type: ClusterIP
```

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. è®¤è¯æˆæƒ
```yaml
JWTè®¤è¯:
  - Tokenæœ‰æ•ˆæœŸ: 2å°æ—¶
  - Refresh Token: 7å¤©
  - æ”¯æŒTokenåˆ·æ–°æœºåˆ¶
  
æƒé™æ§åˆ¶:
  - RBACæ¨¡å‹
  - ç§Ÿæˆ·éš”ç¦»
  - æ¥å£çº§åˆ«æƒé™æ§åˆ¶
  - æ•°æ®çº§åˆ«æƒé™æ§åˆ¶

APIå®‰å…¨:
  - HTTPSå¼ºåˆ¶
  - è¯·æ±‚ç­¾åéªŒè¯
  - é™æµé˜²åˆ·
  - SQLæ³¨å…¥é˜²æŠ¤
```

### 2. æ•°æ®å®‰å…¨
```yaml
æ•°æ®åŠ å¯†:
  - æ•°æ®åº“è¿æ¥SSL
  - æ•æ„Ÿå­—æ®µAESåŠ å¯†
  - å¯†ç BCryptå“ˆå¸Œ
  - ä¼ è¾“å±‚TLS1.3

å®¡è®¡æ—¥å¿—:
  - æ“ä½œæ—¥å¿—è®°å½•
  - æ•æ„Ÿæ“ä½œå®¡è®¡
  - ç™»å½•æ—¥å¿—è·Ÿè¸ª
  - æ•°æ®å˜æ›´è®°å½•
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥
```yaml
å¤šçº§ç¼“å­˜:
  - L1: æœ¬åœ°ç¼“å­˜ (Caffeine)
  - L2: Redisåˆ†å¸ƒå¼ç¼“å­˜
  - L3: CDNé™æ€èµ„æºç¼“å­˜

ç¼“å­˜åœºæ™¯:
  - è´¦å·åŸºæœ¬ä¿¡æ¯: 1å°æ—¶
  - ä¼šè¯åˆ—è¡¨: 30åˆ†é’Ÿ  
  - æ¶ˆæ¯æ¨¡æ¿: 24å°æ—¶
  - é…ç½®ä¿¡æ¯: 1å°æ—¶

ç¼“å­˜æ›´æ–°:
  - å†™å…¥æ—¶æ›´æ–°
  - å®šæ—¶åˆ·æ–°
  - äº‹ä»¶é©±åŠ¨æ›´æ–°
```

### 2. æ•°æ®åº“ä¼˜åŒ–
```yaml
è¯»å†™åˆ†ç¦»:
  - ä¸»åº“: å†™æ“ä½œ
  - ä»åº“: è¯»æ“ä½œ
  - è¯»å†™è·¯ç”±è‡ªåŠ¨åˆ‡æ¢

åˆ†åº“åˆ†è¡¨:
  - æ¶ˆæ¯è®°å½•æŒ‰æœˆåˆ†è¡¨
  - è´¦å·æŒ‰ç§Ÿæˆ·IDåˆ†ç‰‡
  - çŠ¶æ€å†å²æŒ‰è´¦å·IDåˆ†ç‰‡

ç´¢å¼•ä¼˜åŒ–:
  - è”åˆç´¢å¼•è¦†ç›–æŸ¥è¯¢
  - å®šæœŸåˆ†ææ…¢æŸ¥è¯¢
  - ç´¢å¼•ä½¿ç”¨ç‡ç›‘æ§
```

### 3. å¼‚æ­¥å¤„ç†
```yaml
æ¶ˆæ¯é˜Ÿåˆ—:
  - æ¶ˆæ¯å‘é€å¼‚æ­¥åŒ–
  - å›è°ƒå¤„ç†å¼‚æ­¥åŒ–
  - ç›‘æ§æ•°æ®å¼‚æ­¥å†™å…¥

æ‰¹å¤„ç†:
  - æ‰¹é‡æ¶ˆæ¯å‘é€
  - æ‰¹é‡çŠ¶æ€æ›´æ–°
  - æ‰¹é‡æ—¥å¿—å†™å…¥

ä»»åŠ¡è°ƒåº¦:
  - è´¦å·çŠ¶æ€æ£€æŸ¥
  - æ•°æ®æ¸…ç†ä»»åŠ¡
  - æŠ¥è¡¨ç”Ÿæˆä»»åŠ¡
```

## ğŸ“ˆ æ‰©å®¹æ–¹æ¡ˆ

### 1. æ°´å¹³æ‰©å±•
- **æ— çŠ¶æ€æœåŠ¡**ï¼šæ”¯æŒä»»æ„æ‰©å®¹
- **æ•°æ®åº“åˆ†ç‰‡**ï¼šæŒ‰ä¸šåŠ¡ç»´åº¦åˆ†ç‰‡
- **æ¶ˆæ¯é˜Ÿåˆ—é›†ç¾¤**ï¼šå¢åŠ èŠ‚ç‚¹æå‡åå
- **ç¼“å­˜é›†ç¾¤**ï¼šRedis Clusteræ¨¡å¼

### 2. å‚ç›´æ‰©å±•
- **èµ„æºå‡çº§**ï¼šCPUã€å†…å­˜æŒ‰éœ€å‡çº§
- **å­˜å‚¨æ‰©å®¹**ï¼šç£ç›˜ç©ºé—´åŠ¨æ€æ‰©å±•
- **ç½‘ç»œå¸¦å®½**ï¼šæ ¹æ®æµé‡è°ƒæ•´

### 3. å¤šæœºæˆ¿éƒ¨ç½²
- **å¼‚åœ°å¤šæ´»**ï¼šå¤šæœºæˆ¿éƒ¨ç½²
- **æ•°æ®åŒæ­¥**ï¼šä¸»ä»å¤åˆ¶+è¯»å†™åˆ†ç¦»
- **æ•…éšœåˆ‡æ¢**ï¼šè‡ªåŠ¨æ•…éšœè½¬ç§»
- **è´Ÿè½½å‡è¡¡**ï¼šè·¨æœºæˆ¿æµé‡åˆ†å‘

---

## ğŸ“‹ å®æ–½è®¡åˆ’

### Phase 1: æ ¸å¿ƒåŠŸèƒ½å¼€å‘ (4å‘¨)
- [ ] è´¦å·ç®¡ç†æœåŠ¡åŸºç¡€åŠŸèƒ½
- [ ] æ¶ˆæ¯å‘é€æ ¸å¿ƒåŠŸèƒ½  
- [ ] åŸºç¡€ç›‘æ§å‘Šè­¦
- [ ] æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡

### Phase 2: å®Œå–„åŠŸèƒ½ (4å‘¨)
- [ ] å›è°ƒå¤„ç†å®Œå–„
- [ ] æ¶ˆæ¯æ¨¡æ¿ç³»ç»Ÿ
- [ ] ç›‘æ§é¢æ¿å¼€å‘
- [ ] APIç½‘å…³é›†æˆ

### Phase 3: ç”Ÿäº§éƒ¨ç½² (2å‘¨)
- [ ] å®¹å™¨åŒ–éƒ¨ç½²
- [ ] å‹åŠ›æµ‹è¯•
- [ ] å®‰å…¨åŠ å›º
- [ ] ä¸Šçº¿éƒ¨ç½²

### Phase 4: ä¼˜åŒ–è¿­ä»£ (æŒç»­)
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] åŠŸèƒ½å¢å¼º
- [ ] è¿ç»´è‡ªåŠ¨åŒ–
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–

è¿™å¥—ç³»ç»Ÿè®¾è®¡æ¶µç›–äº†ä¼å¾®ç®¡ç†çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œæ”¯æŒå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚æ‚¨è§‰å¾—å“ªä¸ªéƒ¨åˆ†éœ€è¦è¿›ä¸€æ­¥ç»†åŒ–æˆ–è°ƒæ•´ï¼Ÿ 