# 企业微信API最小Demo

这是一个企业微信API的最小demo，实现了基本的登录流程和消息发送功能。

## ✨ 功能特性

- 🔧 **实例管理**: 创建、查看、删除企微实例
- 📋 **实例监控**: 实时查看实例状态和数量统计  
- 🔗 **回调处理**: 实时接收企微事件通知
- 📱 **二维码登录**: 获取登录二维码，支持扫码登录
- 💬 **消息发送**: 支持发送文本消息到私聊和群聊
- 📊 **状态监控**: 实时监控登录状态和消息事件
- 🎯 **实例选择**: 交互式选择现有实例或创建新实例
- 🧠 **智能检测**: 自动区分在线、运行中、停止状态
- 🔧 **状态诊断**: 一键检查GUID、登录状态和实例状态

## 🚀 快速开始

### 前置条件

1. **企微API服务**: 确保企微API服务已启动（默认端口8080）
2. **Python环境**: Python 3.7+
3. **网络环境**: 确保回调地址可访问

### 安装依赖

```bash
pip install -r requirements.txt

# 或手动安装依赖
pip install requests flask qrcode[pil]
```

### 运行Demo

```bash
python demo.py
```

### 主菜单功能

启动后会显示主菜单：

```
🔧 企业微信API Demo - 主菜单
==================================================
1. 📋 查看实例列表
2. 🎯 选择/创建实例  
3. 📱 查看会话列表
4. 💬 发送消息
5. 📊 状态检查
6. 🔧 API端点调试
7. 🚪 退出程序
==================================================
💡 请选择功能 (1-7):
```

## 📋 功能详解

### 1. 实例管理

**查看实例列表**：
- 显示所有实例的GUID和状态
- 支持删除不需要的实例
- 实时状态监控（停止/运行/在线）

**实例状态说明**：
- 🔴 **停止**: 实例未运行
- 🟡 **运行**: 实例运行中但未登录
- 🟢 **在线**: 实例已登录并在线

### 2. 实例选择功能

**智能实例管理**：
- 🔍 自动检测服务器上的所有实例
- 🟢 区分在线实例（可直接使用）
- 🟡 区分运行中实例（需要登录）
- 🔴 区分停止实例（需要启动）

**灵活选择方式**：
- 🔗 一键使用在线实例（推荐）
- 🚀 创建全新实例
- 🔧 手动选择特定实例
- 🗑️ 批量删除停止的实例

**智能登录管理**：
- ✅ 在线实例：直接使用，无需重新登录
- 🟡 运行中实例：提供选择是否立即登录
- 🎯 用户主动控制，避免意外自动操作

### 3. 二维码显示功能

**控制台二维码**：
- 🎨 在终端直接显示ASCII艺术二维码
- 🔄 二维码过期时自动重新显示
- ⚡ 支持多种显示格式（ASCII艺术/Unicode块字符）

**登录状态提示**：
- ⏳ 未扫码
- ✅ 已扫码！请在手机上确认登录  
- 🔐 新设备登录需要验证码！
- 🎉 登录成功！
- ❌ 登录失败，请重试

**兼容性方案**：
- 主要方案：ASCII艺术二维码
- 备用方案：Unicode块字符显示
- 降级方案：纯文本链接显示

### 3. 登录流程

登录流程自动执行以下步骤：

1. **创建实例** - 创建企微虚拟实例
2. **设置回调** - 配置事件回调地址  
3. **设置代理** - 配置本地代理ID（可选）
4. **获取二维码** - 生成登录二维码并在控制台显示
5. **等待扫码** - 等待用户扫码登录
6. **验证码处理** - 新设备登录时自动提示输入验证码
7. **登录成功** - 接收登录成功回调

### 验证码功能

当在新设备上首次登录时，企业微信会要求输入验证码：

- 🔐 **自动检测**: 系统自动检测需要验证码的状态 (status=10)
- 💭 **用户友好**: 清晰的验证码输入提示和错误处理
- 🔄 **重试机制**: 支持最多3次验证码输入尝试
- ✅ **即时反馈**: 实时显示验证码提交结果

**验证码输入流程**：
```
🔐 新设备登录安全验证
============================================================
💡 首次在此设备登录需要验证码确认
📱 请在企业微信中获取验证码
------------------------------------------------------------

💭 验证码输入 (第1次，共3次机会)
🔑 请输入验证码: [用户输入]
📤 正在提交验证码: 123456
✅ 验证码提交成功！请等待登录确认...
```

### 回调调试功能

#### 📊 增强的调试日志
程序现在会显示所有收到的回调数据：

```bash
🔍 收到回调数据:
📊 完整数据: {
  "notify_type": 11002,
  "guid": "xxxxx",
  "data": {
    "status": 10,
    "qrcode_content": "https://work.weixin.qq.com/..."
  }
}
📞 处理回调: notify_type=11002
🔔 处理二维码状态变化回调
📱 二维码状态: 需要验证码 (status=10)
🔐 新设备登录需要验证码！
```

#### 🔧 回调测试工具
如果没有收到回调，可以使用测试工具：

```bash
# 在另一个终端运行测试工具
python test_callback.py
```

**测试工具功能**：
- ✅ 检查回调服务器状态
- 🧪 模拟验证码需求回调 (status=10)
- 📱 测试所有二维码状态回调
- 🔧 交互式回调测试
- 📊 显示详细的回调日志

#### 🌐 回调服务器端点
- `POST /webhook` - 接收企微API回调
- `GET /webhook` - 测试回调服务器状态
- `GET /health` - 健康检查（显示当前状态）

### 4. 会话管理

**查看会话列表**：
- 📱 获取所有可用的conversation_id
- 🔍 显示会话类型（私聊/群聊）
- 📋 提供交互式选择界面
- 📊 显示会话详细信息

**Conversation ID 格式**：
- `S:788xxxxx` 或 `S:168xxxxx` = 私聊
- `R:10xxxxxxx` = 群聊

### 5. 消息发送

**智能消息发送**：
- 📋 从会话列表选择收信人
- ✏️ 手动输入conversation_id
- 💬 支持普通文本消息（私聊+群聊通用）
- 🏷️ 支持群@消息（@特定人员或@全部人）
- 🤖 自动检测群聊并提供@消息选项
- 🧠 智能GUID检测，自动关联在线实例
- ✅ 实时发送状态反馈

**智能GUID管理**：
- 🔍 自动检测服务器上的现有实例
- 🟢 优先关联在线状态的实例
- 🟡 备选关联运行中的实例
- 📊 实时状态同步和检测
- ⚡ 无需手动管理GUID生命周期

**状态检查功能**：
- 🆔 显示当前demo对象的GUID
- 🔐 显示登录状态
- 📱 显示实例在线状态
- 🔍 列出服务器上所有实例及状态
- 👁️ 可视化标识当前关联的实例

**消息接口对比**：
- **通用接口** `/msg/send_text`: 适用于私聊和群聊的普通消息
- **群聊专用** `/msg/send_room_at`: 仅群聊，支持@功能
  - `at_list: [0]` → @全部人（需要群主/管理员权限）
  - `at_list: ["user1", "user2"]` → @特定成员
  - 支持 `{$@}` 占位符调整@位置

**发送流程**：
```
💬 消息发送功能
==================================================
1. 📋 从会话列表选择
2. ✏️  手动输入conversation_id  
3. 🔙 返回主菜单

选择会话后输入消息内容即可发送
```

## 📚 使用示例

### 会话管理和消息发送流程

**步骤1: 登录**
```bash
python demo.py
# 选择 "2. 🚀 开始登录流程"
# 扫码登录（如需验证码会自动提示）
```

**步骤2: 查看会话列表**
```bash
# 选择 "3. 📱 查看会话列表"
📋 获取会话列表
============================================================

📊 共找到 5 个会话:
--------------------------------------------------------------------------------
序号  会话ID                    类型    名称                最后消息时间
--------------------------------------------------------------------------------
1    S:788123456789            私聊    张三                2025-01-29 16:30
2    S:168987654321            私聊    李四                2025-01-29 15:45  
3    R:1012345678901           群聊    项目讨论群           2025-01-29 16:25
4    R:1098765432109           群聊    技术交流群           2025-01-29 14:20
5    S:788555666777            私聊    王五                2025-01-29 13:15
--------------------------------------------------------------------------------
💡 会话ID格式说明:
  - S:788xxxxx 或 S:168xxxxx = 私聊
  - R:10xxxxxxx = 群聊
```

**步骤3: 发送消息**
```bash
# 选择 "4. 💬 发送消息"
# 选择 "1. 📋 从会话列表选择"
# 输入序号选择收信人

# 如果选择群聊，系统会提供@消息选项：
🏷️ 检测到群聊，可以发送@消息
1. 💬 普通消息
2. 🏷️ @特定人员（需要用户ID）
3. 📢 @全部人

# 选择消息类型后输入内容
💬 请输入消息内容 (普通消息): 大家好！
📤 正在发送普通消息到: R:1012345678901
✅ 消息发送成功！
```

## 🔧 配置说明

### API服务器地址
```python
# 默认配置
api_base_url = "http://localhost:8080"

# 可在启动时修改
🌐 API服务器地址 (默认 http://localhost:8080): http://your-api-server:8080
```

### 回调地址
```python
# 固定配置
notify_url = "http://localhost:5000/webhook"
```

### 客户端类型
```python
# 支持的客户端类型（来自更新日志）
client_types = {
    241: "Windows 4.1.2",
    242: "iPad 4.1.2", 
    243: "Windows 4.1.10",
    244: "Mac 4.1.2",
    # ... 更多版本
    262: "Mac 4.1.36"  # 默认使用
}
```

## 💬 消息发送

登录成功后，可以发送文本消息：

### 会话ID格式
- **私聊**: `S:788xxxxx`（788开头的微信外部联系人）
- **群聊**: `R:10xxxxxxx`（10开头的外部群）
- **企微用户**: `S:168xxxxx`（168开头的企微用户）

### 交互命令
```bash
💡 输入 'send' 发送消息, 'quit' 退出: send
📝 请输入conversation_id: S:7881234567890
💬 请输入消息内容: 你好，这是一条测试消息
```

## 📞 回调事件

Demo会自动处理以下回调事件：

| 事件类型 | 描述 | 处理方式 |
|---------|------|---------|
| 11002 | 二维码状态变化 | 显示扫码状态 |
| 11003 | 登录成功 | 设置登录状态，保存用户信息 |
| 11004 | 退出登录 | 清除登录状态 |
| 11010 | 新消息 | 显示收到的消息 |
| 11013 | 消息同步回调 | 实时同步发送/接收的消息（新发现）|

## 🔍 状态监控

### 二维码状态
```
📱 二维码状态: 未扫码          # status = 0
📱 二维码状态: 已扫码，等待确认    # status = 1  
📱 二维码状态: 登录成功         # status = 2
📱 二维码状态: 登录失败         # status = 3
📱 二维码状态: 登录被拒绝        # status = 4
📱 二维码状态: 需要验证码        # status = 10
```

### 心跳检测
```
💓 心跳检测 - 在线状态正常    # 每10秒检测一次
⚠️  检测到离线状态         # 登录状态异常
```

## 🔧 自定义扩展

### 添加新的消息类型

```python
def send_image_message(self, conversation_id, image_path):
    """发送图片消息"""
    data = {
        "guid": self.guid,
        "conversation_id": conversation_id, 
        "image_path": image_path
    }
    return self.api_request("/msg/send_image", data)
```

### 处理更多回调事件

```python
def process_callback(self, data):
    """扩展回调处理"""
    notify_type = data.get("notify_type")
    
    # 添加新的事件类型
    if notify_type == 2131:  # 好友变化
        self.handle_friend_change(data.get("data", {}))
    elif notify_type == 1001:  # 群名称变化  
        self.handle_room_name_change(data.get("data", {}))
```

## ⚠️ 注意事项

1. **测试环境**: 建议在测试环境中使用，避免影响生产数据
2. **实例管理**: 一个实例只能登录一个企微账号
3. **回调地址**: 确保回调地址在企微服务器可访问
4. **代理设置**: 如有网络代理需求，需正确配置bridge参数
5. **错误处理**: Demo包含基本错误处理，生产环境需增强

## 🐛 常见问题

### Q: 实例创建失败 - "达到上限"
**A**: 当前实例数量已达上限，请先删除不需要的实例：
1. 选择"查看实例列表"
2. 查看实例状态，删除停止状态的实例
3. 重新创建实例

### Q: API请求失败
**A**: 检查企微API服务是否启动，端口是否正确

### Q: 回调不工作  
**A**: 确认回调地址可访问，检查防火墙设置

### Q: 登录超时
**A**: 检查二维码是否过期，网络是否稳定

### Q: 消息发送失败
**A**: 确认conversation_id格式正确，账号已登录

## 📚 API文档参考

### 实例管理
- **创建实例**: `/client/create_client`
- **获取实例列表**: `/client/all_clients`
- **获取实例状态**: `/client/get_client_status` 
- **删除实例**: `/client/remove_client`

### 登录相关
- **设置回调**: `/client/set_notify_url`
- **设置代理**: `/client/set_bridge`
- **获取二维码**: `/login/get_login_qrcode`
- **登录验证码**: `/login/verify_login_qrcode`

### 会话相关
- **获取会话列表**: `/session/get_session_list`

### 消息相关
- **发送文本消息**: `/msg/send_text` (通用，私聊+群聊)
- **发送群@消息**: `/msg/send_room_at` (群聊专用，支持@功能)

更多API详情请参考项目中的 `企微协议-广州孤星/api/` 目录下的文档。

## 🔗 相关链接

- [企微开放平台文档](https://developer.work.weixin.qq.com/)
- [企微协议API文档](./企微协议-广州孤星/docs/)

## 📝 更新日志

### v1.8.0 (最新)
- ✅ 新增交互式实例选择功能，支持主动选择使用已有实例
- ✅ 智能区分在线、运行中、停止状态的实例
- ✅ 支持直接使用在线实例，无需重新登录
- ✅ 支持对运行中实例进行登录操作
- ✅ 支持批量删除停止的实例
- ✅ 优化用户控制体验，用户可主动选择而非被动自动检测

### v1.7.0  
- ✅ 新增智能GUID检测功能，自动关联现有在线实例
- ✅ 新增状态检查功能，一键查看当前GUID和登录状态
- ✅ 优化用户体验，移除"需先登录"提示，支持智能检测
- ✅ 增强错误恢复能力，自动处理GUID缺失问题

### v1.6.0  
- ✅ 新增群@消息功能，支持@特定人员和@全部人
- ✅ 智能检测群聊并自动提供@消息选项
- ✅ 双接口支持：通用文本消息 + 群聊专用@消息
- ✅ 完善的群聊权限提示（@全部人需要管理员权限）

### v1.5.0
- ✅ 新增会话管理功能，自动获取所有conversation_id
- ✅ 智能消息发送界面，支持从会话列表选择收信人
- ✅ 显示会话详细信息（类型、名称、最后消息时间）
- ✅ 增强回调调试功能，详细日志和测试工具
- ✅ 优化用户体验，无需手动输入conversation_id

### v1.4.0
- ✅ 新增登录验证码功能，支持新设备安全验证
- ✅ 智能检测验证码需求状态 (status=10)
- ✅ 用户友好的验证码输入界面和错误处理
- ✅ 支持多次重试机制（最多3次尝试）

### v1.3.0
- ✅ 新增控制台二维码显示功能，支持ASCII艺术二维码
- ✅ 自动检测二维码刷新并重新显示
- ✅ 增强登录状态提示，实时显示扫码进度
- ✅ 添加Unicode块字符备用显示方案

### v1.2.1
- ✅ 修复删除实例后查询空列表的TypeError错误
- ✅ 新增API端点调试功能，支持多种HTTP方法自动尝试
- ✅ 增强空值处理逻辑，避免None类型导致的崩溃
- ✅ 优化错误提示信息和用户体验

### v1.2.0
- ✅ 修复API响应格式兼容性问题
- ✅ 增强错误处理，特别是"实例数达到上限"的友好提示
- ✅ 新增完整的实例管理功能（查看列表、状态检查、删除）
- ✅ 重构主菜单为交互式界面
- ✅ 新增启动时实例状态概览

### v1.0.0
- 基础登录流程和消息发送功能
- 后续版本将支持更多消息类型和高级功能 