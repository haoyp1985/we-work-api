---
alwaysApply: true
---

# ğŸ”Œ APIè®¾è®¡å’Œå®ç°è§„åˆ™

## ğŸ“ RESTful APIè®¾è®¡è§„èŒƒ

### 1. URLè®¾è®¡è§„åˆ™
```yaml
URLç»“æ„è§„èŒƒ:
  åŸºç¡€æ ¼å¼: https://api.domain.com/api/v1/resource
  
  è§„åˆ™:
    - ä½¿ç”¨å°å†™å­—æ¯å’ŒçŸ­æ¨ªçº¿åˆ†éš”
    - èµ„æºåä½¿ç”¨å¤æ•°å½¢å¼
    - é¿å…åŠ¨è¯ï¼Œä½¿ç”¨HTTPæ–¹æ³•è¡¨ç¤ºåŠ¨ä½œ
    - å±‚çº§ä¸è¶…è¿‡3å±‚
    
  æ­£ç¡®ç¤ºä¾‹:
    GET    /api/v1/accounts                    # è·å–è´¦å·åˆ—è¡¨
    POST   /api/v1/accounts                    # åˆ›å»ºè´¦å·
    GET    /api/v1/accounts/{id}               # è·å–å•ä¸ªè´¦å·
    PUT    /api/v1/accounts/{id}               # æ›´æ–°è´¦å·
    DELETE /api/v1/accounts/{id}               # åˆ é™¤è´¦å·
    GET    /api/v1/accounts/{id}/messages      # è·å–è´¦å·çš„æ¶ˆæ¯åˆ—è¡¨
    
  é”™è¯¯ç¤ºä¾‹:
    GET    /api/v1/getAccount/{id}             # åŒ…å«åŠ¨è¯
    POST   /api/v1/account                     # èµ„æºåå•æ•°
    GET    /api/v1/Accounts                    # å¤§å†™å­—æ¯
    GET    /api/v1/accounts_list               # ä¸‹åˆ’çº¿åˆ†éš”
```

### 2. HTTPæ–¹æ³•ä½¿ç”¨è§„èŒƒ
```yaml
HTTPæ–¹æ³•è§„èŒƒ:
  GET:    æŸ¥è¯¢æ“ä½œï¼Œå¹‚ç­‰ï¼Œæ— å‰¯ä½œç”¨
  POST:   åˆ›å»ºæ“ä½œï¼Œéå¹‚ç­‰
  PUT:    æ›´æ–°æ“ä½œ(å…¨é‡)ï¼Œå¹‚ç­‰
  PATCH:  æ›´æ–°æ“ä½œ(éƒ¨åˆ†)ï¼Œå¹‚ç­‰
  DELETE: åˆ é™¤æ“ä½œï¼Œå¹‚ç­‰
  
  çŠ¶æ€ç è§„èŒƒ:
    2xx: æˆåŠŸ
      200: æˆåŠŸ(GET/PUT/PATCH)
      201: åˆ›å»ºæˆåŠŸ(POST)
      204: åˆ é™¤æˆåŠŸ(DELETE)
    4xx: å®¢æˆ·ç«¯é”™è¯¯
      400: è¯·æ±‚å‚æ•°é”™è¯¯
      401: æœªè®¤è¯
      403: æ— æƒé™
      404: èµ„æºä¸å­˜åœ¨
      409: èµ„æºå†²çª
    5xx: æœåŠ¡ç«¯é”™è¯¯
      500: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
      503: æœåŠ¡ä¸å¯ç”¨
```

## ğŸ“¨ ç»Ÿä¸€å“åº”æ ¼å¼

### 1. æˆåŠŸå“åº”æ ¼å¼
```java
// âœ… æ­£ç¡®çš„å“åº”æ ¼å¼
@Data
public class Result<T> {
    private Integer code;
    private String message;
    private T data;
    private Long timestamp;
    private String requestId;
    
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("success");
        result.setData(data);
        result.setTimestamp(System.currentTimeMillis());
        result.setRequestId(MDC.get("requestId"));
        return result;
    }
}

// æ§åˆ¶å™¨ä¸­çš„ä½¿ç”¨
@RestController
@RequestMapping("/api/v1/accounts")
public class AccountController {
    
    @GetMapping("/{id}")
    public Result<AccountDTO> getAccount(@PathVariable String id) {
        AccountDTO account = accountService.getAccount(getCurrentTenantId(), id);
        return Result.success(account);
    }
    
    @GetMapping
    public Result<PageResult<AccountDTO>> getAccounts(
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        PageResult<AccountDTO> pageResult = accountService.getAccounts(
            getCurrentTenantId(), pageNum, pageSize);
        return Result.success(pageResult);
    }
}
```

### 2. é”™è¯¯å“åº”æ ¼å¼
```java
// âœ… ç»Ÿä¸€å¼‚å¸¸å¤„ç†
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(ValidationException.class)
    public Result<Void> handleValidationException(ValidationException e) {
        return Result.error(ErrorCode.PARAM_ERROR, e.getMessage());
    }
    
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        return Result.error(e.getErrorCode(), e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.error(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
    }
}

// é”™è¯¯ç å®šä¹‰
public enum ErrorCode {
    SUCCESS(200, "æ“ä½œæˆåŠŸ"),
    PARAM_ERROR(400, "å‚æ•°é”™è¯¯"),
    UNAUTHORIZED(401, "æœªç™»å½•"),
    FORBIDDEN(403, "æ— æƒé™"),
    NOT_FOUND(404, "èµ„æºä¸å­˜åœ¨"),
    CONFLICT(409, "èµ„æºå†²çª"),
    SYSTEM_ERROR(500, "ç³»ç»Ÿé”™è¯¯"),
    
    // ä¸šåŠ¡é”™è¯¯ç 
    ACCOUNT_NOT_FOUND(40001, "è´¦å·ä¸å­˜åœ¨"),
    ACCOUNT_QUOTA_EXCEEDED(40002, "è´¦å·é…é¢å·²æ»¡"),
    MESSAGE_SEND_FAILED(40003, "æ¶ˆæ¯å‘é€å¤±è´¥");
    
    private final Integer code;
    private final String message;
}
```

## ğŸ” è®¤è¯æˆæƒè§„åˆ™

### 1. JWT Tokenå¤„ç†
```java
// âœ… æ­£ç¡®çš„è®¤è¯å®ç°
@Component
public class JwtAuthenticationFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        String token = getTokenFromRequest(httpRequest);
        
        if (StringUtils.hasText(token) && jwtUtils.validateToken(token)) {
            // è§£æç”¨æˆ·ä¿¡æ¯
            UserContext userContext = jwtUtils.parseToken(token);
            
            // è®¾ç½®ä¸Šä¸‹æ–‡
            UserContextHolder.setContext(userContext);
            
            // è®¾ç½®è¯·æ±‚ID
            String requestId = UUID.randomUUID().toString();
            MDC.put("requestId", requestId);
            MDC.put("tenantId", userContext.getTenantId());
            MDC.put("userId", userContext.getUserId());
        }
        
        try {
            chain.doFilter(request, response);
        } finally {
            // æ¸…ç†ä¸Šä¸‹æ–‡
            UserContextHolder.clear();
            MDC.clear();
        }
    }
    
    private String getTokenFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}

// ç”¨æˆ·ä¸Šä¸‹æ–‡
@Data
public class UserContext {
    private String userId;
    private String tenantId;
    private String username;
    private List<String> roles;
    private List<String> permissions;
}
```

### 2. æƒé™æ§åˆ¶
```java
// âœ… æ–¹æ³•çº§æƒé™æ§åˆ¶
@RestController
@RequestMapping("/api/v1/accounts")
public class AccountController {
    
    @GetMapping("/{id}")
    @PreAuthorize("hasPermission('account', 'read')")
    public Result<AccountDTO> getAccount(@PathVariable String id) {
        return Result.success(accountService.getAccount(getCurrentTenantId(), id));
    }
    
    @PostMapping
    @PreAuthorize("hasPermission('account', 'create')")
    public Result<AccountDTO> createAccount(@Valid @RequestBody CreateAccountRequest request) {
        AccountDTO account = accountService.createAccount(getCurrentTenantId(), request);
        return Result.success(account);
    }
    
    @DeleteMapping("/{id}")
    @PreAuthorize("hasPermission('account', 'delete')")
    public Result<Void> deleteAccount(@PathVariable String id) {
        accountService.deleteAccount(getCurrentTenantId(), id);
        return Result.success();
    }
    
    private String getCurrentTenantId() {
        return UserContextHolder.getContext().getTenantId();
    }
}
```

## ğŸ“‹ å‚æ•°éªŒè¯è§„åˆ™

### 1. è¯·æ±‚å‚æ•°éªŒè¯
```java
// âœ… æ­£ç¡®çš„å‚æ•°éªŒè¯
@Data
@Valid
public class CreateAccountRequest {
    
    @NotBlank(message = "è´¦å·åç§°ä¸èƒ½ä¸ºç©º")
    @Length(min = 2, max = 50, message = "è´¦å·åç§°é•¿åº¦å¿…é¡»åœ¨2-50ä¹‹é—´")
    private String accountName;
    
    @NotBlank(message = "ä¼å¾®GUIDä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^[a-zA-Z0-9_-]+$", message = "ä¼å¾®GUIDæ ¼å¼ä¸æ­£ç¡®")
    private String weWorkGuid;
    
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;
    
    @NotNull(message = "é…ç½®ä¿¡æ¯ä¸èƒ½ä¸ºç©º")
    @Valid
    private AccountConfigDTO config;
    
    @JsonProperty("account_name")
    public String getAccountName() {
        return accountName;
    }
}

@Data
public class AccountConfigDTO {
    
    @NotNull(message = "æœ€å¤§è”ç³»äººæ•°é‡ä¸èƒ½ä¸ºç©º")
    @Min(value = 1, message = "æœ€å¤§è”ç³»äººæ•°é‡ä¸èƒ½å°äº1")
    @Max(value = 10000, message = "æœ€å¤§è”ç³»äººæ•°é‡ä¸èƒ½å¤§äº10000")
    private Integer maxContacts;
    
    @NotNull(message = "æ˜¯å¦å¯ç”¨è‡ªåŠ¨å›å¤ä¸èƒ½ä¸ºç©º")
    private Boolean autoReplyEnabled;
}
```

### 2. åˆ†é¡µå‚æ•°å¤„ç†
```java
// âœ… ç»Ÿä¸€åˆ†é¡µå¤„ç†
@Data
public class PageQuery {
    
    @Min(value = 1, message = "é¡µç ä¸èƒ½å°äº1")
    private Integer pageNum = 1;
    
    @Min(value = 1, message = "é¡µå¤§å°ä¸èƒ½å°äº1")
    @Max(value = 100, message = "é¡µå¤§å°ä¸èƒ½å¤§äº100")
    private Integer pageSize = 20;
    
    private String sortBy;
    
    @Pattern(regexp = "^(asc|desc)$", message = "æ’åºæ–¹å‘åªèƒ½æ˜¯ascæˆ–desc")
    private String sortOrder = "desc";
}

@Data
public class PageResult<T> {
    private List<T> records;
    private Long total;
    private Integer pageNum;
    private Integer pageSize;
    private Integer pages;
    
    public static <T> PageResult<T> of(List<T> records, Long total, 
                                      Integer pageNum, Integer pageSize) {
        PageResult<T> result = new PageResult<>();
        result.setRecords(records);
        result.setTotal(total);
        result.setPageNum(pageNum);
        result.setPageSize(pageSize);
        result.setPages((int) Math.ceil((double) total / pageSize));
        return result;
    }
}
```

## ğŸ”„ å¼‚æ­¥å¤„ç†è§„åˆ™

### 1. å¼‚æ­¥æ¥å£è®¾è®¡
```java
// âœ… å¼‚æ­¥ä»»åŠ¡å¤„ç†
@RestController
@RequestMapping("/api/v1/messages")
public class MessageController {
    
    @PostMapping("/batch-send")
    public Result<String> batchSendMessages(@Valid @RequestBody BatchSendRequest request) {
        // åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
        String taskId = messageService.createBatchSendTask(getCurrentTenantId(), request);
        return Result.success(taskId);
    }
    
    @GetMapping("/tasks/{taskId}")
    public Result<TaskStatusDTO> getTaskStatus(@PathVariable String taskId) {
        TaskStatusDTO status = messageService.getTaskStatus(getCurrentTenantId(), taskId);
        return Result.success(status);
    }
}

@Service
public class MessageService {
    
    @Async("taskExecutor")
    public CompletableFuture<Void> processBatchSendTask(String tenantId, String taskId, 
                                                       BatchSendRequest request) {
        try {
            // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºè¿›è¡Œä¸­
            taskService.updateTaskStatus(taskId, TaskStatus.RUNNING);
            
            // æ‰§è¡Œæ‰¹é‡å‘é€
            List<String> messageIds = batchSendMessages(tenantId, request);
            
            // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆ
            taskService.updateTaskStatus(taskId, TaskStatus.COMPLETED, messageIds);
            
        } catch (Exception e) {
            // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥
            taskService.updateTaskStatus(taskId, TaskStatus.FAILED, e.getMessage());
            throw e;
        }
        return CompletableFuture.completedFuture(null);
    }
}
```

### 2. å›è°ƒå¤„ç†
```java
// âœ… å›è°ƒæ¥å£è®¾è®¡
@RestController
@RequestMapping("/api/v1/callbacks")
public class CallbackController {
    
    @PostMapping("/wework/message-status")
    public Result<Void> handleMessageStatusCallback(@RequestBody MessageStatusCallback callback,
                                                   HttpServletRequest request) {
        // éªŒè¯å›è°ƒç­¾å
        if (!callbackService.verifySignature(request, callback)) {
            throw new BusinessException(ErrorCode.INVALID_SIGNATURE);
        }
        
        // å¼‚æ­¥å¤„ç†å›è°ƒ
        callbackService.processMessageStatusCallback(callback);
        
        return Result.success();
    }
}

@Component
public class CallbackService {
    
    @Async("callbackExecutor")
    public void processMessageStatusCallback(MessageStatusCallback callback) {
        try {
            // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
            messageService.updateMessageStatus(callback.getMessageId(), 
                                             callback.getStatus());
            
            // å‘é€çŠ¶æ€å˜æ›´äº‹ä»¶
            eventPublisher.publishMessageStatusChanged(callback);
            
        } catch (Exception e) {
            log.error("å¤„ç†æ¶ˆæ¯çŠ¶æ€å›è°ƒå¤±è´¥", e);
            // å¯ä»¥è€ƒè™‘é‡è¯•æœºåˆ¶
        }
    }
    
    public boolean verifySignature(HttpServletRequest request, Object callback) {
        String signature = request.getHeader("X-Signature");
        String timestamp = request.getHeader("X-Timestamp");
        
        // éªŒè¯æ—¶é—´æˆ³(é˜²é‡æ”¾æ”»å‡»)
        if (Math.abs(System.currentTimeMillis() - Long.parseLong(timestamp)) > 300000) {
            return false;
        }
        
        // éªŒè¯ç­¾å
        String expectedSignature = calculateSignature(callback, timestamp);
        return signature.equals(expectedSignature);
    }
}
```

## ğŸ“Š APIç›‘æ§è§„åˆ™

### 1. æ¥å£ç›‘æ§
```java
// âœ… æ¥å£æ€§èƒ½ç›‘æ§
@Aspect
@Component
public class ApiMonitorAspect {
    
    private final MeterRegistry meterRegistry;
    
    @Around("@annotation(org.springframework.web.bind.annotation.RequestMapping) || " +
            "@annotation(org.springframework.web.bind.annotation.GetMapping) || " +
            "@annotation(org.springframework.web.bind.annotation.PostMapping)")
    public Object monitorApi(ProceedingJoinPoint point) throws Throwable {
        String methodName = point.getSignature().getName();
        String className = point.getTarget().getClass().getSimpleName();
        String apiName = className + "." + methodName;
        
        Timer.Sample sample = Timer.start(meterRegistry);
        
        try {
            Object result = point.proceed();
            
            // è®°å½•æˆåŠŸæŒ‡æ ‡
            meterRegistry.counter("api.requests.total", 
                                "api", apiName, "status", "success").increment();
            
            return result;
            
        } catch (Exception e) {
            // è®°å½•å¤±è´¥æŒ‡æ ‡
            meterRegistry.counter("api.requests.total", 
                                "api", apiName, "status", "error").increment();
            throw e;
            
        } finally {
            // è®°å½•å“åº”æ—¶é—´
            sample.stop(Timer.builder("api.response.time")
                           .tag("api", apiName)
                           .register(meterRegistry));
        }
    }
}
```

### 2. é™æµé…ç½®
```java
// âœ… æ¥å£é™æµ
@RestController
@RequestMapping("/api/v1/accounts")
public class AccountController {
    
    @GetMapping
    @RateLimiter(name = "account-query", fallbackMethod = "getAccountsFallback")
    public Result<PageResult<AccountDTO>> getAccounts(PageQuery query) {
        PageResult<AccountDTO> result = accountService.getAccounts(
            getCurrentTenantId(), query);
        return Result.success(result);
    }
    
    @PostMapping
    @RateLimiter(name = "account-create", fallbackMethod = "createAccountFallback")
    public Result<AccountDTO> createAccount(@Valid @RequestBody CreateAccountRequest request) {
        AccountDTO account = accountService.createAccount(getCurrentTenantId(), request);
        return Result.success(account);
    }
    
    // é™çº§æ–¹æ³•
    public Result<PageResult<AccountDTO>> getAccountsFallback(PageQuery query, Exception e) {
        log.warn("è´¦å·æŸ¥è¯¢æ¥å£é™æµï¼Œè¿”å›ç©ºç»“æœ");
        return Result.success(PageResult.empty());
    }
    
    public Result<AccountDTO> createAccountFallback(CreateAccountRequest request, Exception e) {
        log.warn("è´¦å·åˆ›å»ºæ¥å£é™æµ");
        throw new BusinessException(ErrorCode.RATE_LIMIT_EXCEEDED, "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

**è§„åˆ™æ€»ç»“**:
- æ‰€æœ‰APIå¿…é¡»éµå¾ªRESTfulè®¾è®¡è§„èŒƒ
- ç»Ÿä¸€ä½¿ç”¨ResultåŒ…è£…å“åº”æ•°æ®
- å¿…é¡»è¿›è¡Œå‚æ•°éªŒè¯å’Œæƒé™æ§åˆ¶
- å¼‚æ­¥æ“ä½œéœ€è¦æä¾›ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢æ¥å£
- é‡è¦æ¥å£å¿…é¡»é…ç½®é™æµå’Œç›‘æ§
- å›è°ƒæ¥å£éœ€è¦éªŒè¯ç­¾åå’Œé˜²é‡æ”¾æ”»å‡»# ğŸ”Œ APIè®¾è®¡å’Œå®ç°è§„åˆ™

## ğŸ“ RESTful APIè®¾è®¡è§„èŒƒ

### 1. URLè®¾è®¡è§„åˆ™
```yaml
URLç»“æ„è§„èŒƒ:
  åŸºç¡€æ ¼å¼: https://api.domain.com/api/v1/resource
  
  è§„åˆ™:
    - ä½¿ç”¨å°å†™å­—æ¯å’ŒçŸ­æ¨ªçº¿åˆ†éš”
    - èµ„æºåä½¿ç”¨å¤æ•°å½¢å¼
    - é¿å…åŠ¨è¯ï¼Œä½¿ç”¨HTTPæ–¹æ³•è¡¨ç¤ºåŠ¨ä½œ
    - å±‚çº§ä¸è¶…è¿‡3å±‚
    
  æ­£ç¡®ç¤ºä¾‹:
    GET    /api/v1/accounts                    # è·å–è´¦å·åˆ—è¡¨
    POST   /api/v1/accounts                    # åˆ›å»ºè´¦å·
    GET    /api/v1/accounts/{id}               # è·å–å•ä¸ªè´¦å·
    PUT    /api/v1/accounts/{id}               # æ›´æ–°è´¦å·
    DELETE /api/v1/accounts/{id}               # åˆ é™¤è´¦å·
    GET    /api/v1/accounts/{id}/messages      # è·å–è´¦å·çš„æ¶ˆæ¯åˆ—è¡¨
    
  é”™è¯¯ç¤ºä¾‹:
    GET    /api/v1/getAccount/{id}             # åŒ…å«åŠ¨è¯
    POST   /api/v1/account                     # èµ„æºåå•æ•°
    GET    /api/v1/Accounts                    # å¤§å†™å­—æ¯
    GET    /api/v1/accounts_list               # ä¸‹åˆ’çº¿åˆ†éš”
```

### 2. HTTPæ–¹æ³•ä½¿ç”¨è§„èŒƒ
```yaml
HTTPæ–¹æ³•è§„èŒƒ:
  GET:    æŸ¥è¯¢æ“ä½œï¼Œå¹‚ç­‰ï¼Œæ— å‰¯ä½œç”¨
  POST:   åˆ›å»ºæ“ä½œï¼Œéå¹‚ç­‰
  PUT:    æ›´æ–°æ“ä½œ(å…¨é‡)ï¼Œå¹‚ç­‰
  PATCH:  æ›´æ–°æ“ä½œ(éƒ¨åˆ†)ï¼Œå¹‚ç­‰
  DELETE: åˆ é™¤æ“ä½œï¼Œå¹‚ç­‰
  
  çŠ¶æ€ç è§„èŒƒ:
    2xx: æˆåŠŸ
      200: æˆåŠŸ(GET/PUT/PATCH)
      201: åˆ›å»ºæˆåŠŸ(POST)
      204: åˆ é™¤æˆåŠŸ(DELETE)
    4xx: å®¢æˆ·ç«¯é”™è¯¯
      400: è¯·æ±‚å‚æ•°é”™è¯¯
      401: æœªè®¤è¯
      403: æ— æƒé™
      404: èµ„æºä¸å­˜åœ¨
      409: èµ„æºå†²çª
    5xx: æœåŠ¡ç«¯é”™è¯¯
      500: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
      503: æœåŠ¡ä¸å¯ç”¨
```

## ğŸ“¨ ç»Ÿä¸€å“åº”æ ¼å¼

### 1. æˆåŠŸå“åº”æ ¼å¼
```java
// âœ… æ­£ç¡®çš„å“åº”æ ¼å¼
@Data
public class Result<T> {
    private Integer code;
    private String message;
    private T data;
    private Long timestamp;
    private String requestId;
    
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("success");
        result.setData(data);
        result.setTimestamp(System.currentTimeMillis());
        result.setRequestId(MDC.get("requestId"));
        return result;
    }
}

// æ§åˆ¶å™¨ä¸­çš„ä½¿ç”¨
@RestController
@RequestMapping("/api/v1/accounts")
public class AccountController {
    
    @GetMapping("/{id}")
    public Result<AccountDTO> getAccount(@PathVariable String id) {
        AccountDTO account = accountService.getAccount(getCurrentTenantId(), id);
        return Result.success(account);
    }
    
    @GetMapping
    public Result<PageResult<AccountDTO>> getAccounts(
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        PageResult<AccountDTO> pageResult = accountService.getAccounts(
            getCurrentTenantId(), pageNum, pageSize);
        return Result.success(pageResult);
    }
}
```

### 2. é”™è¯¯å“åº”æ ¼å¼
```java
// âœ… ç»Ÿä¸€å¼‚å¸¸å¤„ç†
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(ValidationException.class)
    public Result<Void> handleValidationException(ValidationException e) {
        return Result.error(ErrorCode.PARAM_ERROR, e.getMessage());
    }
    
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        return Result.error(e.getErrorCode(), e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.error(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
    }
}

// é”™è¯¯ç å®šä¹‰
public enum ErrorCode {
    SUCCESS(200, "æ“ä½œæˆåŠŸ"),
    PARAM_ERROR(400, "å‚æ•°é”™è¯¯"),
    UNAUTHORIZED(401, "æœªç™»å½•"),
    FORBIDDEN(403, "æ— æƒé™"),
    NOT_FOUND(404, "èµ„æºä¸å­˜åœ¨"),
    CONFLICT(409, "èµ„æºå†²çª"),
    SYSTEM_ERROR(500, "ç³»ç»Ÿé”™è¯¯"),
    
    // ä¸šåŠ¡é”™è¯¯ç 
    ACCOUNT_NOT_FOUND(40001, "è´¦å·ä¸å­˜åœ¨"),
    ACCOUNT_QUOTA_EXCEEDED(40002, "è´¦å·é…é¢å·²æ»¡"),
    MESSAGE_SEND_FAILED(40003, "æ¶ˆæ¯å‘é€å¤±è´¥");
    
    private final Integer code;
    private final String message;
}
```

## ğŸ” è®¤è¯æˆæƒè§„åˆ™

### 1. JWT Tokenå¤„ç†
```java
// âœ… æ­£ç¡®çš„è®¤è¯å®ç°
@Component
public class JwtAuthenticationFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        String token = getTokenFromRequest(httpRequest);
        
        if (StringUtils.hasText(token) && jwtUtils.validateToken(token)) {
            // è§£æç”¨æˆ·ä¿¡æ¯
            UserContext userContext = jwtUtils.parseToken(token);
            
            // è®¾ç½®ä¸Šä¸‹æ–‡
            UserContextHolder.setContext(userContext);
            
            // è®¾ç½®è¯·æ±‚ID
            String requestId = UUID.randomUUID().toString();
            MDC.put("requestId", requestId);
            MDC.put("tenantId", userContext.getTenantId());
            MDC.put("userId", userContext.getUserId());
        }
        
        try {
            chain.doFilter(request, response);
        } finally {
            // æ¸…ç†ä¸Šä¸‹æ–‡
            UserContextHolder.clear();
            MDC.clear();
        }
    }
    
    private String getTokenFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}

// ç”¨æˆ·ä¸Šä¸‹æ–‡
@Data
public class UserContext {
    private String userId;
    private String tenantId;
    private String username;
    private List<String> roles;
    private List<String> permissions;
}
```

### 2. æƒé™æ§åˆ¶
```java
// âœ… æ–¹æ³•çº§æƒé™æ§åˆ¶
@RestController
@RequestMapping("/api/v1/accounts")
public class AccountController {
    
    @GetMapping("/{id}")
    @PreAuthorize("hasPermission('account', 'read')")
    public Result<AccountDTO> getAccount(@PathVariable String id) {
        return Result.success(accountService.getAccount(getCurrentTenantId(), id));
    }
    
    @PostMapping
    @PreAuthorize("hasPermission('account', 'create')")
    public Result<AccountDTO> createAccount(@Valid @RequestBody CreateAccountRequest request) {
        AccountDTO account = accountService.createAccount(getCurrentTenantId(), request);
        return Result.success(account);
    }
    
    @DeleteMapping("/{id}")
    @PreAuthorize("hasPermission('account', 'delete')")
    public Result<Void> deleteAccount(@PathVariable String id) {
        accountService.deleteAccount(getCurrentTenantId(), id);
        return Result.success();
    }
    
    private String getCurrentTenantId() {
        return UserContextHolder.getContext().getTenantId();
    }
}
```

## ğŸ“‹ å‚æ•°éªŒè¯è§„åˆ™

### 1. è¯·æ±‚å‚æ•°éªŒè¯
```java
// âœ… æ­£ç¡®çš„å‚æ•°éªŒè¯
@Data
@Valid
public class CreateAccountRequest {
    
    @NotBlank(message = "è´¦å·åç§°ä¸èƒ½ä¸ºç©º")
    @Length(min = 2, max = 50, message = "è´¦å·åç§°é•¿åº¦å¿…é¡»åœ¨2-50ä¹‹é—´")
    private String accountName;
    
    @NotBlank(message = "ä¼å¾®GUIDä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^[a-zA-Z0-9_-]+$", message = "ä¼å¾®GUIDæ ¼å¼ä¸æ­£ç¡®")
    private String weWorkGuid;
    
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;
    
    @NotNull(message = "é…ç½®ä¿¡æ¯ä¸èƒ½ä¸ºç©º")
    @Valid
    private AccountConfigDTO config;
    
    @JsonProperty("account_name")
    public String getAccountName() {
        return accountName;
    }
}

@Data
public class AccountConfigDTO {
    
    @NotNull(message = "æœ€å¤§è”ç³»äººæ•°é‡ä¸èƒ½ä¸ºç©º")
    @Min(value = 1, message = "æœ€å¤§è”ç³»äººæ•°é‡ä¸èƒ½å°äº1")
    @Max(value = 10000, message = "æœ€å¤§è”ç³»äººæ•°é‡ä¸èƒ½å¤§äº10000")
    private Integer maxContacts;
    
    @NotNull(message = "æ˜¯å¦å¯ç”¨è‡ªåŠ¨å›å¤ä¸èƒ½ä¸ºç©º")
    private Boolean autoReplyEnabled;
}
```

### 2. åˆ†é¡µå‚æ•°å¤„ç†
```java
// âœ… ç»Ÿä¸€åˆ†é¡µå¤„ç†
@Data
public class PageQuery {
    
    @Min(value = 1, message = "é¡µç ä¸èƒ½å°äº1")
    private Integer pageNum = 1;
    
    @Min(value = 1, message = "é¡µå¤§å°ä¸èƒ½å°äº1")
    @Max(value = 100, message = "é¡µå¤§å°ä¸èƒ½å¤§äº100")
    private Integer pageSize = 20;
    
    private String sortBy;
    
    @Pattern(regexp = "^(asc|desc)$", message = "æ’åºæ–¹å‘åªèƒ½æ˜¯ascæˆ–desc")
    private String sortOrder = "desc";
}

@Data
public class PageResult<T> {
    private List<T> records;
    private Long total;
    private Integer pageNum;
    private Integer pageSize;
    private Integer pages;
    
    public static <T> PageResult<T> of(List<T> records, Long total, 
                                      Integer pageNum, Integer pageSize) {
        PageResult<T> result = new PageResult<>();
        result.setRecords(records);
        result.setTotal(total);
        result.setPageNum(pageNum);
        result.setPageSize(pageSize);
        result.setPages((int) Math.ceil((double) total / pageSize));
        return result;
    }
}
```

## ğŸ”„ å¼‚æ­¥å¤„ç†è§„åˆ™

### 1. å¼‚æ­¥æ¥å£è®¾è®¡
```java
// âœ… å¼‚æ­¥ä»»åŠ¡å¤„ç†
@RestController
@RequestMapping("/api/v1/messages")
public class MessageController {
    
    @PostMapping("/batch-send")
    public Result<String> batchSendMessages(@Valid @RequestBody BatchSendRequest request) {
        // åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
        String taskId = messageService.createBatchSendTask(getCurrentTenantId(), request);
        return Result.success(taskId);
    }
    
    @GetMapping("/tasks/{taskId}")
    public Result<TaskStatusDTO> getTaskStatus(@PathVariable String taskId) {
        TaskStatusDTO status = messageService.getTaskStatus(getCurrentTenantId(), taskId);
        return Result.success(status);
    }
}

@Service
public class MessageService {
    
    @Async("taskExecutor")
    public CompletableFuture<Void> processBatchSendTask(String tenantId, String taskId, 
                                                       BatchSendRequest request) {
        try {
            // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºè¿›è¡Œä¸­
            taskService.updateTaskStatus(taskId, TaskStatus.RUNNING);
            
            // æ‰§è¡Œæ‰¹é‡å‘é€
            List<String> messageIds = batchSendMessages(tenantId, request);
            
            // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆ
            taskService.updateTaskStatus(taskId, TaskStatus.COMPLETED, messageIds);
            
        } catch (Exception e) {
            // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥
            taskService.updateTaskStatus(taskId, TaskStatus.FAILED, e.getMessage());
            throw e;
        }
        return CompletableFuture.completedFuture(null);
    }
}
```

### 2. å›è°ƒå¤„ç†
```java
// âœ… å›è°ƒæ¥å£è®¾è®¡
@RestController
@RequestMapping("/api/v1/callbacks")
public class CallbackController {
    
    @PostMapping("/wework/message-status")
    public Result<Void> handleMessageStatusCallback(@RequestBody MessageStatusCallback callback,
                                                   HttpServletRequest request) {
        // éªŒè¯å›è°ƒç­¾å
        if (!callbackService.verifySignature(request, callback)) {
            throw new BusinessException(ErrorCode.INVALID_SIGNATURE);
        }
        
        // å¼‚æ­¥å¤„ç†å›è°ƒ
        callbackService.processMessageStatusCallback(callback);
        
        return Result.success();
    }
}

@Component
public class CallbackService {
    
    @Async("callbackExecutor")
    public void processMessageStatusCallback(MessageStatusCallback callback) {
        try {
            // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
            messageService.updateMessageStatus(callback.getMessageId(), 
                                             callback.getStatus());
            
            // å‘é€çŠ¶æ€å˜æ›´äº‹ä»¶
            eventPublisher.publishMessageStatusChanged(callback);
            
        } catch (Exception e) {
            log.error("å¤„ç†æ¶ˆæ¯çŠ¶æ€å›è°ƒå¤±è´¥", e);
            // å¯ä»¥è€ƒè™‘é‡è¯•æœºåˆ¶
        }
    }
    
    public boolean verifySignature(HttpServletRequest request, Object callback) {
        String signature = request.getHeader("X-Signature");
        String timestamp = request.getHeader("X-Timestamp");
        
        // éªŒè¯æ—¶é—´æˆ³(é˜²é‡æ”¾æ”»å‡»)
        if (Math.abs(System.currentTimeMillis() - Long.parseLong(timestamp)) > 300000) {
            return false;
        }
        
        // éªŒè¯ç­¾å
        String expectedSignature = calculateSignature(callback, timestamp);
        return signature.equals(expectedSignature);
    }
}
```

## ğŸ“Š APIç›‘æ§è§„åˆ™

### 1. æ¥å£ç›‘æ§
```java
// âœ… æ¥å£æ€§èƒ½ç›‘æ§
@Aspect
@Component
public class ApiMonitorAspect {
    
    private final MeterRegistry meterRegistry;
    
    @Around("@annotation(org.springframework.web.bind.annotation.RequestMapping) || " +
            "@annotation(org.springframework.web.bind.annotation.GetMapping) || " +
            "@annotation(org.springframework.web.bind.annotation.PostMapping)")
    public Object monitorApi(ProceedingJoinPoint point) throws Throwable {
        String methodName = point.getSignature().getName();
        String className = point.getTarget().getClass().getSimpleName();
        String apiName = className + "." + methodName;
        
        Timer.Sample sample = Timer.start(meterRegistry);
        
        try {
            Object result = point.proceed();
            
            // è®°å½•æˆåŠŸæŒ‡æ ‡
            meterRegistry.counter("api.requests.total", 
                                "api", apiName, "status", "success").increment();
            
            return result;
            
        } catch (Exception e) {
            // è®°å½•å¤±è´¥æŒ‡æ ‡
            meterRegistry.counter("api.requests.total", 
                                "api", apiName, "status", "error").increment();
            throw e;
            
        } finally {
            // è®°å½•å“åº”æ—¶é—´
            sample.stop(Timer.builder("api.response.time")
                           .tag("api", apiName)
                           .register(meterRegistry));
        }
    }
}
```

### 2. é™æµé…ç½®
```java
// âœ… æ¥å£é™æµ
@RestController
@RequestMapping("/api/v1/accounts")
public class AccountController {
    
    @GetMapping
    @RateLimiter(name = "account-query", fallbackMethod = "getAccountsFallback")
    public Result<PageResult<AccountDTO>> getAccounts(PageQuery query) {
        PageResult<AccountDTO> result = accountService.getAccounts(
            getCurrentTenantId(), query);
        return Result.success(result);
    }
    
    @PostMapping
    @RateLimiter(name = "account-create", fallbackMethod = "createAccountFallback")
    public Result<AccountDTO> createAccount(@Valid @RequestBody CreateAccountRequest request) {
        AccountDTO account = accountService.createAccount(getCurrentTenantId(), request);
        return Result.success(account);
    }
    
    // é™çº§æ–¹æ³•
    public Result<PageResult<AccountDTO>> getAccountsFallback(PageQuery query, Exception e) {
        log.warn("è´¦å·æŸ¥è¯¢æ¥å£é™æµï¼Œè¿”å›ç©ºç»“æœ");
        return Result.success(PageResult.empty());
    }
    
    public Result<AccountDTO> createAccountFallback(CreateAccountRequest request, Exception e) {
        log.warn("è´¦å·åˆ›å»ºæ¥å£é™æµ");
        throw new BusinessException(ErrorCode.RATE_LIMIT_EXCEEDED, "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

**è§„åˆ™æ€»ç»“**:
- æ‰€æœ‰APIå¿…é¡»éµå¾ªRESTfulè®¾è®¡è§„èŒƒ
- ç»Ÿä¸€ä½¿ç”¨ResultåŒ…è£…å“åº”æ•°æ®
- å¿…é¡»è¿›è¡Œå‚æ•°éªŒè¯å’Œæƒé™æ§åˆ¶
- å¼‚æ­¥æ“ä½œéœ€è¦æä¾›ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢æ¥å£
- é‡è¦æ¥å£å¿…é¡»é…ç½®é™æµå’Œç›‘æ§
- å›è°ƒæ¥å£éœ€è¦éªŒè¯ç­¾åå’Œé˜²é‡æ”¾æ”»å‡»