---
alwaysApply: true
---

# âš™ï¸ è¿ç»´è„šæœ¬å’Œè‡ªåŠ¨åŒ–è§„åˆ™

## ğŸ“ è„šæœ¬å¼€å‘è§„èŒƒ

### 1. Shellè„šæœ¬æ ‡å‡†æ¨¡æ¿
```bash
#!/bin/bash

# =================================================================
# WeWork Platform - [è„šæœ¬åŠŸèƒ½æè¿°]
# ä½œè€…: [ä½œè€…åç§°]
# ç‰ˆæœ¬: 1.0.0
# åˆ›å»º: 2024-01-15
# ç”¨é€”: [è¯¦ç»†ç”¨é€”è¯´æ˜]
# =================================================================

# ä¸¥æ ¼æ¨¡å¼
set -euo pipefail

# å…¨å±€å˜é‡
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
readonly LOG_FILE="/tmp/$(basename "$0" .sh).log"
readonly PID_FILE="/tmp/$(basename "$0" .sh).pid"

# é¢œè‰²è¾“å‡º
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') $*" | tee -a "$LOG_FILE"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') $*" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') $*" | tee -a "$LOG_FILE"
}

log_debug() {
    if [[ "${DEBUG:-false}" == "true" ]]; then
        echo -e "${BLUE}[DEBUG]${NC} $(date '+%Y-%m-%d %H:%M:%S') $*" | tee -a "$LOG_FILE"
    fi
}

# é”™è¯¯å¤„ç†
cleanup() {
    local exit_code=$?
    if [[ -f "$PID_FILE" ]]; then
        rm -f "$PID_FILE"
    fi
    if [[ $exit_code -ne 0 ]]; then
        log_error "è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $exit_code"
    fi
    exit $exit_code
}

# è®¾ç½®é™·é˜±
trap cleanup EXIT
trap 'log_error "è„šæœ¬è¢«ä¸­æ–­"; exit 130' INT
trap 'log_error "è„šæœ¬è¢«ç»ˆæ­¢"; exit 143' TERM

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    local deps=("docker" "docker-compose" "curl" "jq")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            log_error "ä¾èµ– $dep æœªå®‰è£…"
            exit 1
        fi
    done
}

# æ£€æŸ¥æ˜¯å¦å·²è¿è¡Œ
check_running() {
    if [[ -f "$PID_FILE" ]]; then
        local pid=$(cat "$PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            log_error "è„šæœ¬å·²åœ¨è¿è¡Œï¼ŒPID: $pid"
            exit 1
        else
            rm -f "$PID_FILE"
        fi
    fi
    echo $$ > "$PID_FILE"
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    cat << EOF
ä½¿ç”¨æ–¹æ³•: $(basename "$0") [é€‰é¡¹] [å‘½ä»¤]

é€‰é¡¹:
  -h, --help      æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  -v, --verbose   è¯¦ç»†è¾“å‡º
  -d, --debug     è°ƒè¯•æ¨¡å¼

å‘½ä»¤:
  start           å¯åŠ¨æœåŠ¡
  stop            åœæ­¢æœåŠ¡
  restart         é‡å¯æœåŠ¡
  status          æ£€æŸ¥çŠ¶æ€

ç¤ºä¾‹:
  $(basename "$0") start
  $(basename "$0") --debug status

EOF
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹æ‰§è¡Œè„šæœ¬: $(basename "$0")"
    
    # æ£€æŸ¥ä¾èµ–å’Œè¿è¡ŒçŠ¶æ€
    check_dependencies
    check_running
    
    # è„šæœ¬ä¸»è¦é€»è¾‘
    case "${1:-}" in
        start)
            start_service
            ;;
        stop)
            stop_service
            ;;
        restart)
            restart_service
            ;;
        status)
            check_status
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            log_error "æœªçŸ¥å‘½ä»¤: $*"
            show_help
            exit 1
            ;;
    esac
    
    log_info "è„šæœ¬æ‰§è¡Œå®Œæˆ"
}

# å‚æ•°è§£æ
while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--verbose)
            set -x
            shift
            ;;
        -d|--debug)
            DEBUG=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

## ğŸš€ æœåŠ¡ç®¡ç†è„šæœ¬è§„èŒƒ

### 1. ç»Ÿä¸€æœåŠ¡ç®¡ç†è„šæœ¬
```bash
# âœ… manage-services.sh æ ¸å¿ƒåŠŸèƒ½ç»“æ„
#!/bin/bash

# æœåŠ¡é…ç½® (æ ¼å¼: key:service-name:port)
SERVICES=(
    "gateway:gateway-service:18080"
    "account:account-service:18081" 
    "message:message-service:18082"
    "monitor:monitor-service:18083"
)

# è·å–æœåŠ¡ä¿¡æ¯
get_service_info() {
    local service_key=$1
    for service_info in "${SERVICES[@]}"; do
        IFS=':' read -r key name port <<< "$service_info"
        if [[ "$key" == "$service_key" ]]; then
            echo "$name:$port"
            return 0
        fi
    done
    return 1
}

# æ„å»ºæœåŠ¡
build_service() {
    local service_key=$1
    local service_info
    service_info=$(get_service_info "$service_key")
    if [[ $? -ne 0 ]]; then
        log_error "æœªçŸ¥æœåŠ¡: $service_key"
        return 1
    fi
    
    IFS=':' read -r service_name port <<< "$service_info"
    local service_path="$BACKEND_PATH/$service_name"
    
    if [[ ! -d "$service_path" ]]; then
        log_error "æœåŠ¡ç›®å½•ä¸å­˜åœ¨: $service_path"
        return 1
    fi
    
    log_info "æ„å»ºæœåŠ¡: $service_name"
    
    cd "$service_path"
    
    # æ¸…ç†å’Œæ„å»º
    mvn clean package -DskipTests -q
    if [[ $? -eq 0 ]]; then
        log_info "âœ… æœåŠ¡æ„å»ºæˆåŠŸ: $service_name"
    else
        log_error "âŒ æœåŠ¡æ„å»ºå¤±è´¥: $service_name"
        return 1
    fi
}

# å¯åŠ¨æœåŠ¡
start_service() {
    local service_key=$1
    local service_info
    service_info=$(get_service_info "$service_key")
    if [[ $? -ne 0 ]]; then
        log_error "æœªçŸ¥æœåŠ¡: $service_key"
        return 1
    fi
    
    IFS=':' read -r service_name port <<< "$service_info"
    
    # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
    if netstat -tulnp 2>/dev/null | grep -q ":$port "; then
        log_warn "ç«¯å£ $port å·²è¢«å ç”¨ï¼Œå°è¯•åœæ­¢ç°æœ‰è¿›ç¨‹"
        stop_service "$service_key"
        sleep 2
    fi
    
    local service_path="$BACKEND_PATH/$service_name"
    local jar_file="$service_path/target/$service_name.jar"
    
    if [[ ! -f "$jar_file" ]]; then
        log_warn "JARæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•æ„å»º: $jar_file"
        build_service "$service_key"
    fi
    
    log_info "å¯åŠ¨æœåŠ¡: $service_name (ç«¯å£: $port)"
    
    # è®¾ç½®JVMå‚æ•°
    local java_opts="-Xms256m -Xmx512m -XX:+UseG1GC"
    java_opts="$java_opts -Dspring.profiles.active=${PROFILE:-dev}"
    java_opts="$java_opts -Dserver.port=$port"
    
    # åå°å¯åŠ¨æœåŠ¡
    nohup java $java_opts -jar "$jar_file" \
        > "/tmp/$service_name.log" 2>&1 &
    
    local pid=$!
    echo $pid > "/tmp/$service_name.pid"
    
    log_info "æœåŠ¡å¯åŠ¨ä¸­ï¼ŒPID: $pid"
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    local max_attempts=30
    local attempt=0
    while [[ $attempt -lt $max_attempts ]]; do
        if curl -sf "http://localhost:$port/actuator/health" >/dev/null 2>&1; then
            log_info "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ: $service_name"
            return 0
        fi
        ((attempt++))
        sleep 2
    done
    
    log_error "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶: $service_name"
    return 1
}

# åœæ­¢æœåŠ¡
stop_service() {
    local service_key=$1
    local service_info
    service_info=$(get_service_info "$service_key")
    if [[ $? -ne 0 ]]; then
        log_error "æœªçŸ¥æœåŠ¡: $service_key"
        return 1
    fi
    
    IFS=':' read -r service_name port <<< "$service_info"
    local pid_file="/tmp/$service_name.pid"
    
    if [[ -f "$pid_file" ]]; then
        local pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            log_info "åœæ­¢æœåŠ¡: $service_name (PID: $pid)"
            kill "$pid"
            
            # ç­‰å¾…è¿›ç¨‹ç»“æŸ
            local max_attempts=10
            local attempt=0
            while [[ $attempt -lt $max_attempts ]]; do
                if ! kill -0 "$pid" 2>/dev/null; then
                    break
                fi
                ((attempt++))
                sleep 1
            done
            
            # å¼ºåˆ¶æ€æ­»
            if kill -0 "$pid" 2>/dev/null; then
                log_warn "å¼ºåˆ¶åœæ­¢æœåŠ¡: $service_name"
                kill -9 "$pid"
            fi
            
            rm -f "$pid_file"
            log_info "âœ… æœåŠ¡å·²åœæ­¢: $service_name"
        else
            log_warn "PIDæ–‡ä»¶å­˜åœ¨ä½†è¿›ç¨‹ä¸å­˜åœ¨ï¼Œæ¸…ç†PIDæ–‡ä»¶"
            rm -f "$pid_file"
        fi
    else
        # é€šè¿‡ç«¯å£æŸ¥æ‰¾è¿›ç¨‹
        local pids
        pids=$(lsof -ti:$port 2>/dev/null)
        if [[ -n "$pids" ]]; then
            log_info "é€šè¿‡ç«¯å£åœæ­¢æœåŠ¡: $service_name (ç«¯å£: $port)"
            echo "$pids" | xargs kill
            log_info "âœ… æœåŠ¡å·²åœæ­¢: $service_name"
        else
            log_warn "æœåŠ¡æœªè¿è¡Œ: $service_name"
        fi
    fi
}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service_status() {
    local service_key=$1
    local service_info
    service_info=$(get_service_info "$service_key")
    if [[ $? -ne 0 ]]; then
        echo "UNKNOWN"
        return 1
    fi
    
    IFS=':' read -r service_name port <<< "$service_info"
    
    # æ£€æŸ¥å¥åº·ç«¯ç‚¹
    if curl -sf "http://localhost:$port/actuator/health" >/dev/null 2>&1; then
        echo "RUNNING"
    else
        echo "STOPPED"
    fi
}
```

## ğŸ³ åŸºç¡€è®¾æ–½ç®¡ç†è„šæœ¬

### 1. åŸºç¡€è®¾æ–½å¯åŠ¨è„šæœ¬
```bash
# âœ… start-infrastructure.sh æ ¸å¿ƒé€»è¾‘
start_infrastructure() {
    log_info "ğŸš€ å¯åŠ¨ä¼ä¸šå¾®ä¿¡ç®¡ç†å¹³å°åŸºç¡€è®¾æ–½..."
    
    # æ£€æŸ¥Docker
    if ! docker info >/dev/null 2>&1; then
        log_error "âŒ Dockeræœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨Docker"
        exit 1
    fi
    
    cd "$PROJECT_ROOT/infrastructure/docker"
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    create_directories
    
    # è®¾ç½®é¡¹ç›®åç§°
    local project_name="wework-platform"
    
    # æ‹‰å–é•œåƒ
    log_info "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
    docker-compose -p "$project_name" pull
    
    # å¯åŠ¨æ ¸å¿ƒæœåŠ¡
    start_core_services "$project_name"
    
    # å¯åŠ¨ç›‘æ§æœåŠ¡
    start_monitoring_services "$project_name"
    
    # å¯åŠ¨åº”ç”¨æœåŠ¡  
    start_application_services "$project_name"
    
    # éªŒè¯æœåŠ¡çŠ¶æ€
    verify_services
    
    log_info "âœ… åŸºç¡€è®¾æ–½å¯åŠ¨å®Œæˆ"
}

create_directories() {
    log_info "ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•..."
    
    local dirs=(
        "monitoring/grafana/provisioning/dashboards"
        "monitoring/grafana/provisioning/datasources"
        "logs"
        "database/data"
        "messaging/rocketmq/logs"
        "messaging/rocketmq/store"
    )
    
    for dir in "${dirs[@]}"; do
        mkdir -p "$dir"
        log_debug "åˆ›å»ºç›®å½•: $dir"
    done
}

start_core_services() {
    local project_name=$1
    
    log_info "ğŸ—„ï¸ å¯åŠ¨æ ¸å¿ƒæ•°æ®æœåŠ¡..."
    docker-compose -p "$project_name" up -d mysql redis influxdb
    
    log_info "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
    wait_for_service "mysql" "3306" 60
    wait_for_service "redis" "6379" 30
    wait_for_service "influxdb" "8086" 30
}

start_monitoring_services() {
    local project_name=$1
    
    log_info "ğŸ“Š å¯åŠ¨ç›‘æ§æœåŠ¡..."
    docker-compose -p "$project_name" up -d prometheus grafana elasticsearch kibana logstash
    
    log_info "â³ ç­‰å¾…ç›‘æ§æœåŠ¡å¯åŠ¨..."
    wait_for_service "prometheus" "9090" 30
    wait_for_service "grafana" "3000" 30
}

wait_for_service() {
    local service_name=$1
    local port=$2
    local timeout=${3:-30}
    local attempt=0
    
    log_info "ç­‰å¾…æœåŠ¡å¯åŠ¨: $service_name (ç«¯å£: $port)"
    
    while [[ $attempt -lt $timeout ]]; do
        if docker-compose ps | grep -q "$service_name.*Up"; then
            if nc -z localhost "$port" 2>/dev/null; then
                log_info "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ: $service_name"
                return 0
            fi
        fi
        ((attempt++))
        sleep 2
        echo -n "."
    done
    
    echo
    log_error "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶: $service_name"
    return 1
}

verify_services() {
    log_info "ğŸ” éªŒè¯æœåŠ¡çŠ¶æ€..."
    
    local services=(
        "mysql:3306:MySQLæ•°æ®åº“"
        "redis:6379:Redisç¼“å­˜"
        "prometheus:9090:Prometheusç›‘æ§"
        "grafana:3000:Grafanaä»ªè¡¨æ¿"
    )
    
    for service_info in "${services[@]}"; do
        IFS=':' read -r service port desc <<< "$service_info"
        
        if nc -z localhost "$port" 2>/dev/null; then
            log_info "âœ… $desc è¿è¡Œæ­£å¸¸ (ç«¯å£: $port)"
        else
            log_warn "âš ï¸ $desc å¯èƒ½æœªæ­£å¸¸å¯åŠ¨ (ç«¯å£: $port)"
        fi
    done
}
```

### 2. å¥åº·æ£€æŸ¥è„šæœ¬
```bash
# âœ… check-services.sh å¥åº·æ£€æŸ¥é€»è¾‘
check_all_services() {
    log_info "ğŸ” å¼€å§‹å…¨é¢å¥åº·æ£€æŸ¥..."
    
    local overall_status="HEALTHY"
    
    # æ£€æŸ¥åŸºç¡€è®¾æ–½
    check_infrastructure_health
    local infra_status=$?
    
    # æ£€æŸ¥åº”ç”¨æœåŠ¡
    check_application_health  
    local app_status=$?
    
    # æ£€æŸ¥å¤–éƒ¨ä¾èµ–
    check_external_dependencies
    local ext_status=$?
    
    if [[ $infra_status -ne 0 || $app_status -ne 0 || $ext_status -ne 0 ]]; then
        overall_status="UNHEALTHY"
    fi
    
    # ç”Ÿæˆå¥åº·æŠ¥å‘Š
    generate_health_report "$overall_status"
    
    log_info "å¥åº·æ£€æŸ¥å®Œæˆï¼Œæ€»ä½“çŠ¶æ€: $overall_status"
    
    if [[ "$overall_status" == "UNHEALTHY" ]]; then
        exit 1
    fi
}

check_infrastructure_health() {
    log_info "æ£€æŸ¥åŸºç¡€è®¾æ–½å¥åº·çŠ¶æ€..."
    
    local services=(
        "mysql:3306:MySQL"
        "redis:6379:Redis" 
        "nacos:8848:Nacos"
        "rocketmq:9876:RocketMQ NameServer"
    )
    
    local failed_services=0
    
    for service_info in "${services[@]}"; do
        IFS=':' read -r service port name <<< "$service_info"
        
        if check_port_health "localhost" "$port"; then
            log_info "âœ… $name å¥åº·"
        else
            log_error "âŒ $name ä¸å¥åº· (ç«¯å£: $port)"
            ((failed_services++))
        fi
    done
    
    return $failed_services
}

check_application_health() {
    log_info "æ£€æŸ¥åº”ç”¨æœåŠ¡å¥åº·çŠ¶æ€..."
    
    local services=(
        "gateway-service:18080:/actuator/health"
        "account-service:18081:/actuator/health"
        "message-service:18082:/actuator/health"
    )
    
    local failed_services=0
    
    for service_info in "${services[@]}"; do
        IFS=':' read -r service port endpoint <<< "$service_info"
        
        local health_url="http://localhost:$port$endpoint"
        if check_http_health "$health_url"; then
            log_info "âœ… $service å¥åº·"
        else
            log_error "âŒ $service ä¸å¥åº·"
            ((failed_services++))
        fi
    done
    
    return $failed_services
}

check_port_health() {
    local host=$1
    local port=$2
    nc -z "$host" "$port" 2>/dev/null
}

check_http_health() {
    local url=$1
    local response
    response=$(curl -sf "$url" 2>/dev/null)
    
    if [[ $? -eq 0 ]]; then
        # æ£€æŸ¥å“åº”å†…å®¹
        if echo "$response" | grep -q '"status":"UP"'; then
            return 0
        fi
    fi
    
    return 1
}

generate_health_report() {
    local overall_status=$1
    local report_file="/tmp/health-report-$(date +%Y%m%d_%H%M%S).json"
    
    cat > "$report_file" << EOF
{
  "timestamp": "$(date -Iseconds)",
  "overall_status": "$overall_status",
  "infrastructure": {
    "mysql": "$(check_port_health localhost 3306 && echo "UP" || echo "DOWN")",
    "redis": "$(check_port_health localhost 6379 && echo "UP" || echo "DOWN")",
    "nacos": "$(check_port_health localhost 8848 && echo "UP" || echo "DOWN")"
  },
  "applications": {
    "gateway": "$(check_http_health "http://localhost:18080/actuator/health" && echo "UP" || echo "DOWN")",
    "account": "$(check_http_health "http://localhost:18081/actuator/health" && echo "UP" || echo "DOWN")",
    "message": "$(check_http_health "http://localhost:18082/actuator/health" && echo "UP" || echo "DOWN")"
  },
  "system": {
    "disk_usage": "$(df -h / | awk 'NR==2 {print $5}')",
    "memory_usage": "$(free -m | awk 'NR==2{printf "%.1f%%", $3*100/$2}')",
    "load_average": "$(uptime | awk -F'load average:' '{print $2}')"
  }
}
EOF
    
    log_info "å¥åº·æŠ¥å‘Šç”Ÿæˆ: $report_file"
    
    # å¦‚æœé…ç½®äº†webhookï¼Œå‘é€æŠ¥å‘Š
    if [[ -n "${HEALTH_WEBHOOK_URL:-}" ]]; then
        curl -sf -X POST "$HEALTH_WEBHOOK_URL" \
             -H "Content-Type: application/json" \
             -d "@$report_file" || true
    fi
}
```

## ğŸ”„ CI/CDè„šæœ¬è§„èŒƒ

### 1. æ„å»ºè„šæœ¬æ ‡å‡†
```bash
# âœ… build-service.sh æ¨¡æ¿
build_service() {
    local service_name=$1
    local version=${2:-"latest"}
    local environment=${3:-"dev"}
    
    log_info "æ„å»ºæœåŠ¡: $service_name, ç‰ˆæœ¬: $version, ç¯å¢ƒ: $environment"
    
    local service_path="$PROJECT_ROOT/backend/$service_name"
    if [[ ! -d "$service_path" ]]; then
        log_error "æœåŠ¡ç›®å½•ä¸å­˜åœ¨: $service_path"
        return 1
    fi
    
    cd "$service_path"
    
    # æ¸…ç†
    log_info "æ¸…ç†æ—§æ„å»º..."
    mvn clean -q
    
    # è¿è¡Œæµ‹è¯•
    if [[ "${SKIP_TESTS:-false}" != "true" ]]; then
        log_info "è¿è¡Œå•å…ƒæµ‹è¯•..."
        mvn test -q
        if [[ $? -ne 0 ]]; then
            log_error "å•å…ƒæµ‹è¯•å¤±è´¥"
            return 1
        fi
    fi
    
    # æ‰“åŒ…
    log_info "æ‰“åŒ…åº”ç”¨..."
    mvn package -DskipTests -q
    if [[ $? -ne 0 ]]; then
        log_error "æ‰“åŒ…å¤±è´¥"
        return 1
    fi
    
    # æ„å»ºDockeré•œåƒ
    log_info "æ„å»ºDockeré•œåƒ..."
    local image_tag="wework/$service_name:$version-$environment"
    
    docker build -t "$image_tag" .
    if [[ $? -eq 0 ]]; then
        log_info "âœ… Dockeré•œåƒæ„å»ºæˆåŠŸ: $image_tag"
        
        # æ¨é€é•œåƒï¼ˆå¦‚æœé…ç½®äº†registryï¼‰
        if [[ -n "${DOCKER_REGISTRY:-}" ]]; then
            push_image "$image_tag"
        fi
    else
        log_error "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥"
        return 1
    fi
}

push_image() {
    local image_tag=$1
    local registry_tag="$DOCKER_REGISTRY/$image_tag"
    
    log_info "æ¨é€é•œåƒåˆ°registry: $registry_tag"
    
    docker tag "$image_tag" "$registry_tag"
    docker push "$registry_tag"
    
    if [[ $? -eq 0 ]]; then
        log_info "âœ… é•œåƒæ¨é€æˆåŠŸ: $registry_tag"
    else
        log_error "âŒ é•œåƒæ¨é€å¤±è´¥"
        return 1
    fi
}
```

### 2. éƒ¨ç½²è„šæœ¬è§„èŒƒ
```bash
# âœ… deploy-service.sh éƒ¨ç½²é€»è¾‘
deploy_service() {
    local service_name=$1
    local version=$2
    local environment=$3
    local namespace=${4:-"wework-$environment"}
    
    log_info "éƒ¨ç½²æœåŠ¡: $service_name, ç‰ˆæœ¬: $version, ç¯å¢ƒ: $environment"
    
    # éªŒè¯éƒ¨ç½²å‰ç½®æ¡ä»¶
    verify_deployment_prerequisites "$environment"
    
    # æ›´æ–°é•œåƒç‰ˆæœ¬
    update_deployment_image "$service_name" "$version" "$environment" "$namespace"
    
    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    wait_for_deployment "$service_name" "$namespace"
    
    # éªŒè¯éƒ¨ç½²ç»“æœ
    verify_deployment "$service_name" "$namespace"
    
    log_info "âœ… æœåŠ¡éƒ¨ç½²å®Œæˆ: $service_name"
}

verify_deployment_prerequisites() {
    local environment=$1
    
    # æ£€æŸ¥kubectlè¿æ¥
    if ! kubectl cluster-info >/dev/null 2>&1; then
        log_error "æ— æ³•è¿æ¥åˆ°Kubernetesé›†ç¾¤"
        return 1
    fi
    
    # æ£€æŸ¥å‘½åç©ºé—´
    if ! kubectl get namespace "wework-$environment" >/dev/null 2>&1; then
        log_info "åˆ›å»ºå‘½åç©ºé—´: wework-$environment"
        kubectl create namespace "wework-$environment"
    fi
    
    # æ£€æŸ¥ConfigMapå’ŒSecret
    check_k8s_configs "$environment"
}

update_deployment_image() {
    local service_name=$1
    local version=$2
    local environment=$3
    local namespace=$4
    
    local deployment_name="$service_name-deployment"
    local image_name="$DOCKER_REGISTRY/wework/$service_name:$version-$environment"
    
    log_info "æ›´æ–°éƒ¨ç½²é•œåƒ: $deployment_name -> $image_name"
    
    kubectl set image "deployment/$deployment_name" \
            "$service_name=$image_name" \
            -n "$namespace"
}

wait_for_deployment() {
    local service_name=$1
    local namespace=$2
    local timeout=${3:-300}
    
    log_info "ç­‰å¾…éƒ¨ç½²å®Œæˆ: $service_name"
    
    kubectl rollout status "deployment/$service_name-deployment" \
            -n "$namespace" \
            --timeout="${timeout}s"
}
```

**è§„åˆ™æ€»ç»“**:
- ç»Ÿä¸€ä½¿ç”¨Shellè„šæœ¬æ¨¡æ¿ï¼ŒåŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- æœåŠ¡ç®¡ç†è„šæœ¬æ”¯æŒæ„å»ºã€å¯åŠ¨ã€åœæ­¢ã€çŠ¶æ€æ£€æŸ¥ç­‰å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- åŸºç¡€è®¾æ–½è„šæœ¬å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œå¥åº·æ£€æŸ¥
- CI/CDè„šæœ¬æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²å’Œå›æ»šæœºåˆ¶
- æ‰€æœ‰è„šæœ¬å¿…é¡»æ”¯æŒå‚æ•°éªŒè¯å’Œå¸®åŠ©ä¿¡æ¯# âš™ï¸ è¿ç»´è„šæœ¬å’Œè‡ªåŠ¨åŒ–è§„åˆ™

## ğŸ“ è„šæœ¬å¼€å‘è§„èŒƒ

### 1. Shellè„šæœ¬æ ‡å‡†æ¨¡æ¿
```bash
#!/bin/bash

# =================================================================
# WeWork Platform - [è„šæœ¬åŠŸèƒ½æè¿°]
# ä½œè€…: [ä½œè€…åç§°]
# ç‰ˆæœ¬: 1.0.0
# åˆ›å»º: 2024-01-15
# ç”¨é€”: [è¯¦ç»†ç”¨é€”è¯´æ˜]
# =================================================================

# ä¸¥æ ¼æ¨¡å¼
set -euo pipefail

# å…¨å±€å˜é‡
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
readonly LOG_FILE="/tmp/$(basename "$0" .sh).log"
readonly PID_FILE="/tmp/$(basename "$0" .sh).pid"

# é¢œè‰²è¾“å‡º
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') $*" | tee -a "$LOG_FILE"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') $*" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') $*" | tee -a "$LOG_FILE"
}

log_debug() {
    if [[ "${DEBUG:-false}" == "true" ]]; then
        echo -e "${BLUE}[DEBUG]${NC} $(date '+%Y-%m-%d %H:%M:%S') $*" | tee -a "$LOG_FILE"
    fi
}

# é”™è¯¯å¤„ç†
cleanup() {
    local exit_code=$?
    if [[ -f "$PID_FILE" ]]; then
        rm -f "$PID_FILE"
    fi
    if [[ $exit_code -ne 0 ]]; then
        log_error "è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $exit_code"
    fi
    exit $exit_code
}

# è®¾ç½®é™·é˜±
trap cleanup EXIT
trap 'log_error "è„šæœ¬è¢«ä¸­æ–­"; exit 130' INT
trap 'log_error "è„šæœ¬è¢«ç»ˆæ­¢"; exit 143' TERM

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    local deps=("docker" "docker-compose" "curl" "jq")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            log_error "ä¾èµ– $dep æœªå®‰è£…"
            exit 1
        fi
    done
}

# æ£€æŸ¥æ˜¯å¦å·²è¿è¡Œ
check_running() {
    if [[ -f "$PID_FILE" ]]; then
        local pid=$(cat "$PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            log_error "è„šæœ¬å·²åœ¨è¿è¡Œï¼ŒPID: $pid"
            exit 1
        else
            rm -f "$PID_FILE"
        fi
    fi
    echo $$ > "$PID_FILE"
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    cat << EOF
ä½¿ç”¨æ–¹æ³•: $(basename "$0") [é€‰é¡¹] [å‘½ä»¤]

é€‰é¡¹:
  -h, --help      æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  -v, --verbose   è¯¦ç»†è¾“å‡º
  -d, --debug     è°ƒè¯•æ¨¡å¼

å‘½ä»¤:
  start           å¯åŠ¨æœåŠ¡
  stop            åœæ­¢æœåŠ¡
  restart         é‡å¯æœåŠ¡
  status          æ£€æŸ¥çŠ¶æ€

ç¤ºä¾‹:
  $(basename "$0") start
  $(basename "$0") --debug status

EOF
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹æ‰§è¡Œè„šæœ¬: $(basename "$0")"
    
    # æ£€æŸ¥ä¾èµ–å’Œè¿è¡ŒçŠ¶æ€
    check_dependencies
    check_running
    
    # è„šæœ¬ä¸»è¦é€»è¾‘
    case "${1:-}" in
        start)
            start_service
            ;;
        stop)
            stop_service
            ;;
        restart)
            restart_service
            ;;
        status)
            check_status
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            log_error "æœªçŸ¥å‘½ä»¤: $*"
            show_help
            exit 1
            ;;
    esac
    
    log_info "è„šæœ¬æ‰§è¡Œå®Œæˆ"
}

# å‚æ•°è§£æ
while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--verbose)
            set -x
            shift
            ;;
        -d|--debug)
            DEBUG=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

## ğŸš€ æœåŠ¡ç®¡ç†è„šæœ¬è§„èŒƒ

### 1. ç»Ÿä¸€æœåŠ¡ç®¡ç†è„šæœ¬
```bash
# âœ… manage-services.sh æ ¸å¿ƒåŠŸèƒ½ç»“æ„
#!/bin/bash

# æœåŠ¡é…ç½® (æ ¼å¼: key:service-name:port)
SERVICES=(
    "gateway:gateway-service:18080"
    "account:account-service:18081" 
    "message:message-service:18082"
    "monitor:monitor-service:18083"
)

# è·å–æœåŠ¡ä¿¡æ¯
get_service_info() {
    local service_key=$1
    for service_info in "${SERVICES[@]}"; do
        IFS=':' read -r key name port <<< "$service_info"
        if [[ "$key" == "$service_key" ]]; then
            echo "$name:$port"
            return 0
        fi
    done
    return 1
}

# æ„å»ºæœåŠ¡
build_service() {
    local service_key=$1
    local service_info
    service_info=$(get_service_info "$service_key")
    if [[ $? -ne 0 ]]; then
        log_error "æœªçŸ¥æœåŠ¡: $service_key"
        return 1
    fi
    
    IFS=':' read -r service_name port <<< "$service_info"
    local service_path="$BACKEND_PATH/$service_name"
    
    if [[ ! -d "$service_path" ]]; then
        log_error "æœåŠ¡ç›®å½•ä¸å­˜åœ¨: $service_path"
        return 1
    fi
    
    log_info "æ„å»ºæœåŠ¡: $service_name"
    
    cd "$service_path"
    
    # æ¸…ç†å’Œæ„å»º
    mvn clean package -DskipTests -q
    if [[ $? -eq 0 ]]; then
        log_info "âœ… æœåŠ¡æ„å»ºæˆåŠŸ: $service_name"
    else
        log_error "âŒ æœåŠ¡æ„å»ºå¤±è´¥: $service_name"
        return 1
    fi
}

# å¯åŠ¨æœåŠ¡
start_service() {
    local service_key=$1
    local service_info
    service_info=$(get_service_info "$service_key")
    if [[ $? -ne 0 ]]; then
        log_error "æœªçŸ¥æœåŠ¡: $service_key"
        return 1
    fi
    
    IFS=':' read -r service_name port <<< "$service_info"
    
    # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
    if netstat -tulnp 2>/dev/null | grep -q ":$port "; then
        log_warn "ç«¯å£ $port å·²è¢«å ç”¨ï¼Œå°è¯•åœæ­¢ç°æœ‰è¿›ç¨‹"
        stop_service "$service_key"
        sleep 2
    fi
    
    local service_path="$BACKEND_PATH/$service_name"
    local jar_file="$service_path/target/$service_name.jar"
    
    if [[ ! -f "$jar_file" ]]; then
        log_warn "JARæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•æ„å»º: $jar_file"
        build_service "$service_key"
    fi
    
    log_info "å¯åŠ¨æœåŠ¡: $service_name (ç«¯å£: $port)"
    
    # è®¾ç½®JVMå‚æ•°
    local java_opts="-Xms256m -Xmx512m -XX:+UseG1GC"
    java_opts="$java_opts -Dspring.profiles.active=${PROFILE:-dev}"
    java_opts="$java_opts -Dserver.port=$port"
    
    # åå°å¯åŠ¨æœåŠ¡
    nohup java $java_opts -jar "$jar_file" \
        > "/tmp/$service_name.log" 2>&1 &
    
    local pid=$!
    echo $pid > "/tmp/$service_name.pid"
    
    log_info "æœåŠ¡å¯åŠ¨ä¸­ï¼ŒPID: $pid"
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    local max_attempts=30
    local attempt=0
    while [[ $attempt -lt $max_attempts ]]; do
        if curl -sf "http://localhost:$port/actuator/health" >/dev/null 2>&1; then
            log_info "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ: $service_name"
            return 0
        fi
        ((attempt++))
        sleep 2
    done
    
    log_error "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶: $service_name"
    return 1
}

# åœæ­¢æœåŠ¡
stop_service() {
    local service_key=$1
    local service_info
    service_info=$(get_service_info "$service_key")
    if [[ $? -ne 0 ]]; then
        log_error "æœªçŸ¥æœåŠ¡: $service_key"
        return 1
    fi
    
    IFS=':' read -r service_name port <<< "$service_info"
    local pid_file="/tmp/$service_name.pid"
    
    if [[ -f "$pid_file" ]]; then
        local pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            log_info "åœæ­¢æœåŠ¡: $service_name (PID: $pid)"
            kill "$pid"
            
            # ç­‰å¾…è¿›ç¨‹ç»“æŸ
            local max_attempts=10
            local attempt=0
            while [[ $attempt -lt $max_attempts ]]; do
                if ! kill -0 "$pid" 2>/dev/null; then
                    break
                fi
                ((attempt++))
                sleep 1
            done
            
            # å¼ºåˆ¶æ€æ­»
            if kill -0 "$pid" 2>/dev/null; then
                log_warn "å¼ºåˆ¶åœæ­¢æœåŠ¡: $service_name"
                kill -9 "$pid"
            fi
            
            rm -f "$pid_file"
            log_info "âœ… æœåŠ¡å·²åœæ­¢: $service_name"
        else
            log_warn "PIDæ–‡ä»¶å­˜åœ¨ä½†è¿›ç¨‹ä¸å­˜åœ¨ï¼Œæ¸…ç†PIDæ–‡ä»¶"
            rm -f "$pid_file"
        fi
    else
        # é€šè¿‡ç«¯å£æŸ¥æ‰¾è¿›ç¨‹
        local pids
        pids=$(lsof -ti:$port 2>/dev/null)
        if [[ -n "$pids" ]]; then
            log_info "é€šè¿‡ç«¯å£åœæ­¢æœåŠ¡: $service_name (ç«¯å£: $port)"
            echo "$pids" | xargs kill
            log_info "âœ… æœåŠ¡å·²åœæ­¢: $service_name"
        else
            log_warn "æœåŠ¡æœªè¿è¡Œ: $service_name"
        fi
    fi
}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service_status() {
    local service_key=$1
    local service_info
    service_info=$(get_service_info "$service_key")
    if [[ $? -ne 0 ]]; then
        echo "UNKNOWN"
        return 1
    fi
    
    IFS=':' read -r service_name port <<< "$service_info"
    
    # æ£€æŸ¥å¥åº·ç«¯ç‚¹
    if curl -sf "http://localhost:$port/actuator/health" >/dev/null 2>&1; then
        echo "RUNNING"
    else
        echo "STOPPED"
    fi
}
```

## ğŸ³ åŸºç¡€è®¾æ–½ç®¡ç†è„šæœ¬

### 1. åŸºç¡€è®¾æ–½å¯åŠ¨è„šæœ¬
```bash
# âœ… start-infrastructure.sh æ ¸å¿ƒé€»è¾‘
start_infrastructure() {
    log_info "ğŸš€ å¯åŠ¨ä¼ä¸šå¾®ä¿¡ç®¡ç†å¹³å°åŸºç¡€è®¾æ–½..."
    
    # æ£€æŸ¥Docker
    if ! docker info >/dev/null 2>&1; then
        log_error "âŒ Dockeræœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨Docker"
        exit 1
    fi
    
    cd "$PROJECT_ROOT/infrastructure/docker"
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    create_directories
    
    # è®¾ç½®é¡¹ç›®åç§°
    local project_name="wework-platform"
    
    # æ‹‰å–é•œåƒ
    log_info "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
    docker-compose -p "$project_name" pull
    
    # å¯åŠ¨æ ¸å¿ƒæœåŠ¡
    start_core_services "$project_name"
    
    # å¯åŠ¨ç›‘æ§æœåŠ¡
    start_monitoring_services "$project_name"
    
    # å¯åŠ¨åº”ç”¨æœåŠ¡  
    start_application_services "$project_name"
    
    # éªŒè¯æœåŠ¡çŠ¶æ€
    verify_services
    
    log_info "âœ… åŸºç¡€è®¾æ–½å¯åŠ¨å®Œæˆ"
}

create_directories() {
    log_info "ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•..."
    
    local dirs=(
        "monitoring/grafana/provisioning/dashboards"
        "monitoring/grafana/provisioning/datasources"
        "logs"
        "database/data"
        "messaging/rocketmq/logs"
        "messaging/rocketmq/store"
    )
    
    for dir in "${dirs[@]}"; do
        mkdir -p "$dir"
        log_debug "åˆ›å»ºç›®å½•: $dir"
    done
}

start_core_services() {
    local project_name=$1
    
    log_info "ğŸ—„ï¸ å¯åŠ¨æ ¸å¿ƒæ•°æ®æœåŠ¡..."
    docker-compose -p "$project_name" up -d mysql redis influxdb
    
    log_info "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
    wait_for_service "mysql" "3306" 60
    wait_for_service "redis" "6379" 30
    wait_for_service "influxdb" "8086" 30
}

start_monitoring_services() {
    local project_name=$1
    
    log_info "ğŸ“Š å¯åŠ¨ç›‘æ§æœåŠ¡..."
    docker-compose -p "$project_name" up -d prometheus grafana elasticsearch kibana logstash
    
    log_info "â³ ç­‰å¾…ç›‘æ§æœåŠ¡å¯åŠ¨..."
    wait_for_service "prometheus" "9090" 30
    wait_for_service "grafana" "3000" 30
}

wait_for_service() {
    local service_name=$1
    local port=$2
    local timeout=${3:-30}
    local attempt=0
    
    log_info "ç­‰å¾…æœåŠ¡å¯åŠ¨: $service_name (ç«¯å£: $port)"
    
    while [[ $attempt -lt $timeout ]]; do
        if docker-compose ps | grep -q "$service_name.*Up"; then
            if nc -z localhost "$port" 2>/dev/null; then
                log_info "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ: $service_name"
                return 0
            fi
        fi
        ((attempt++))
        sleep 2
        echo -n "."
    done
    
    echo
    log_error "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶: $service_name"
    return 1
}

verify_services() {
    log_info "ğŸ” éªŒè¯æœåŠ¡çŠ¶æ€..."
    
    local services=(
        "mysql:3306:MySQLæ•°æ®åº“"
        "redis:6379:Redisç¼“å­˜"
        "prometheus:9090:Prometheusç›‘æ§"
        "grafana:3000:Grafanaä»ªè¡¨æ¿"
    )
    
    for service_info in "${services[@]}"; do
        IFS=':' read -r service port desc <<< "$service_info"
        
        if nc -z localhost "$port" 2>/dev/null; then
            log_info "âœ… $desc è¿è¡Œæ­£å¸¸ (ç«¯å£: $port)"
        else
            log_warn "âš ï¸ $desc å¯èƒ½æœªæ­£å¸¸å¯åŠ¨ (ç«¯å£: $port)"
        fi
    done
}
```

### 2. å¥åº·æ£€æŸ¥è„šæœ¬
```bash
# âœ… check-services.sh å¥åº·æ£€æŸ¥é€»è¾‘
check_all_services() {
    log_info "ğŸ” å¼€å§‹å…¨é¢å¥åº·æ£€æŸ¥..."
    
    local overall_status="HEALTHY"
    
    # æ£€æŸ¥åŸºç¡€è®¾æ–½
    check_infrastructure_health
    local infra_status=$?
    
    # æ£€æŸ¥åº”ç”¨æœåŠ¡
    check_application_health  
    local app_status=$?
    
    # æ£€æŸ¥å¤–éƒ¨ä¾èµ–
    check_external_dependencies
    local ext_status=$?
    
    if [[ $infra_status -ne 0 || $app_status -ne 0 || $ext_status -ne 0 ]]; then
        overall_status="UNHEALTHY"
    fi
    
    # ç”Ÿæˆå¥åº·æŠ¥å‘Š
    generate_health_report "$overall_status"
    
    log_info "å¥åº·æ£€æŸ¥å®Œæˆï¼Œæ€»ä½“çŠ¶æ€: $overall_status"
    
    if [[ "$overall_status" == "UNHEALTHY" ]]; then
        exit 1
    fi
}

check_infrastructure_health() {
    log_info "æ£€æŸ¥åŸºç¡€è®¾æ–½å¥åº·çŠ¶æ€..."
    
    local services=(
        "mysql:3306:MySQL"
        "redis:6379:Redis" 
        "nacos:8848:Nacos"
        "rocketmq:9876:RocketMQ NameServer"
    )
    
    local failed_services=0
    
    for service_info in "${services[@]}"; do
        IFS=':' read -r service port name <<< "$service_info"
        
        if check_port_health "localhost" "$port"; then
            log_info "âœ… $name å¥åº·"
        else
            log_error "âŒ $name ä¸å¥åº· (ç«¯å£: $port)"
            ((failed_services++))
        fi
    done
    
    return $failed_services
}

check_application_health() {
    log_info "æ£€æŸ¥åº”ç”¨æœåŠ¡å¥åº·çŠ¶æ€..."
    
    local services=(
        "gateway-service:18080:/actuator/health"
        "account-service:18081:/actuator/health"
        "message-service:18082:/actuator/health"
    )
    
    local failed_services=0
    
    for service_info in "${services[@]}"; do
        IFS=':' read -r service port endpoint <<< "$service_info"
        
        local health_url="http://localhost:$port$endpoint"
        if check_http_health "$health_url"; then
            log_info "âœ… $service å¥åº·"
        else
            log_error "âŒ $service ä¸å¥åº·"
            ((failed_services++))
        fi
    done
    
    return $failed_services
}

check_port_health() {
    local host=$1
    local port=$2
    nc -z "$host" "$port" 2>/dev/null
}

check_http_health() {
    local url=$1
    local response
    response=$(curl -sf "$url" 2>/dev/null)
    
    if [[ $? -eq 0 ]]; then
        # æ£€æŸ¥å“åº”å†…å®¹
        if echo "$response" | grep -q '"status":"UP"'; then
            return 0
        fi
    fi
    
    return 1
}

generate_health_report() {
    local overall_status=$1
    local report_file="/tmp/health-report-$(date +%Y%m%d_%H%M%S).json"
    
    cat > "$report_file" << EOF
{
  "timestamp": "$(date -Iseconds)",
  "overall_status": "$overall_status",
  "infrastructure": {
    "mysql": "$(check_port_health localhost 3306 && echo "UP" || echo "DOWN")",
    "redis": "$(check_port_health localhost 6379 && echo "UP" || echo "DOWN")",
    "nacos": "$(check_port_health localhost 8848 && echo "UP" || echo "DOWN")"
  },
  "applications": {
    "gateway": "$(check_http_health "http://localhost:18080/actuator/health" && echo "UP" || echo "DOWN")",
    "account": "$(check_http_health "http://localhost:18081/actuator/health" && echo "UP" || echo "DOWN")",
    "message": "$(check_http_health "http://localhost:18082/actuator/health" && echo "UP" || echo "DOWN")"
  },
  "system": {
    "disk_usage": "$(df -h / | awk 'NR==2 {print $5}')",
    "memory_usage": "$(free -m | awk 'NR==2{printf "%.1f%%", $3*100/$2}')",
    "load_average": "$(uptime | awk -F'load average:' '{print $2}')"
  }
}
EOF
    
    log_info "å¥åº·æŠ¥å‘Šç”Ÿæˆ: $report_file"
    
    # å¦‚æœé…ç½®äº†webhookï¼Œå‘é€æŠ¥å‘Š
    if [[ -n "${HEALTH_WEBHOOK_URL:-}" ]]; then
        curl -sf -X POST "$HEALTH_WEBHOOK_URL" \
             -H "Content-Type: application/json" \
             -d "@$report_file" || true
    fi
}
```

## ğŸ”„ CI/CDè„šæœ¬è§„èŒƒ

### 1. æ„å»ºè„šæœ¬æ ‡å‡†
```bash
# âœ… build-service.sh æ¨¡æ¿
build_service() {
    local service_name=$1
    local version=${2:-"latest"}
    local environment=${3:-"dev"}
    
    log_info "æ„å»ºæœåŠ¡: $service_name, ç‰ˆæœ¬: $version, ç¯å¢ƒ: $environment"
    
    local service_path="$PROJECT_ROOT/backend/$service_name"
    if [[ ! -d "$service_path" ]]; then
        log_error "æœåŠ¡ç›®å½•ä¸å­˜åœ¨: $service_path"
        return 1
    fi
    
    cd "$service_path"
    
    # æ¸…ç†
    log_info "æ¸…ç†æ—§æ„å»º..."
    mvn clean -q
    
    # è¿è¡Œæµ‹è¯•
    if [[ "${SKIP_TESTS:-false}" != "true" ]]; then
        log_info "è¿è¡Œå•å…ƒæµ‹è¯•..."
        mvn test -q
        if [[ $? -ne 0 ]]; then
            log_error "å•å…ƒæµ‹è¯•å¤±è´¥"
            return 1
        fi
    fi
    
    # æ‰“åŒ…
    log_info "æ‰“åŒ…åº”ç”¨..."
    mvn package -DskipTests -q
    if [[ $? -ne 0 ]]; then
        log_error "æ‰“åŒ…å¤±è´¥"
        return 1
    fi
    
    # æ„å»ºDockeré•œåƒ
    log_info "æ„å»ºDockeré•œåƒ..."
    local image_tag="wework/$service_name:$version-$environment"
    
    docker build -t "$image_tag" .
    if [[ $? -eq 0 ]]; then
        log_info "âœ… Dockeré•œåƒæ„å»ºæˆåŠŸ: $image_tag"
        
        # æ¨é€é•œåƒï¼ˆå¦‚æœé…ç½®äº†registryï¼‰
        if [[ -n "${DOCKER_REGISTRY:-}" ]]; then
            push_image "$image_tag"
        fi
    else
        log_error "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥"
        return 1
    fi
}

push_image() {
    local image_tag=$1
    local registry_tag="$DOCKER_REGISTRY/$image_tag"
    
    log_info "æ¨é€é•œåƒåˆ°registry: $registry_tag"
    
    docker tag "$image_tag" "$registry_tag"
    docker push "$registry_tag"
    
    if [[ $? -eq 0 ]]; then
        log_info "âœ… é•œåƒæ¨é€æˆåŠŸ: $registry_tag"
    else
        log_error "âŒ é•œåƒæ¨é€å¤±è´¥"
        return 1
    fi
}
```

### 2. éƒ¨ç½²è„šæœ¬è§„èŒƒ
```bash
# âœ… deploy-service.sh éƒ¨ç½²é€»è¾‘
deploy_service() {
    local service_name=$1
    local version=$2
    local environment=$3
    local namespace=${4:-"wework-$environment"}
    
    log_info "éƒ¨ç½²æœåŠ¡: $service_name, ç‰ˆæœ¬: $version, ç¯å¢ƒ: $environment"
    
    # éªŒè¯éƒ¨ç½²å‰ç½®æ¡ä»¶
    verify_deployment_prerequisites "$environment"
    
    # æ›´æ–°é•œåƒç‰ˆæœ¬
    update_deployment_image "$service_name" "$version" "$environment" "$namespace"
    
    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    wait_for_deployment "$service_name" "$namespace"
    
    # éªŒè¯éƒ¨ç½²ç»“æœ
    verify_deployment "$service_name" "$namespace"
    
    log_info "âœ… æœåŠ¡éƒ¨ç½²å®Œæˆ: $service_name"
}

verify_deployment_prerequisites() {
    local environment=$1
    
    # æ£€æŸ¥kubectlè¿æ¥
    if ! kubectl cluster-info >/dev/null 2>&1; then
        log_error "æ— æ³•è¿æ¥åˆ°Kubernetesé›†ç¾¤"
        return 1
    fi
    
    # æ£€æŸ¥å‘½åç©ºé—´
    if ! kubectl get namespace "wework-$environment" >/dev/null 2>&1; then
        log_info "åˆ›å»ºå‘½åç©ºé—´: wework-$environment"
        kubectl create namespace "wework-$environment"
    fi
    
    # æ£€æŸ¥ConfigMapå’ŒSecret
    check_k8s_configs "$environment"
}

update_deployment_image() {
    local service_name=$1
    local version=$2
    local environment=$3
    local namespace=$4
    
    local deployment_name="$service_name-deployment"
    local image_name="$DOCKER_REGISTRY/wework/$service_name:$version-$environment"
    
    log_info "æ›´æ–°éƒ¨ç½²é•œåƒ: $deployment_name -> $image_name"
    
    kubectl set image "deployment/$deployment_name" \
            "$service_name=$image_name" \
            -n "$namespace"
}

wait_for_deployment() {
    local service_name=$1
    local namespace=$2
    local timeout=${3:-300}
    
    log_info "ç­‰å¾…éƒ¨ç½²å®Œæˆ: $service_name"
    
    kubectl rollout status "deployment/$service_name-deployment" \
            -n "$namespace" \
            --timeout="${timeout}s"
}
```

**è§„åˆ™æ€»ç»“**:
- ç»Ÿä¸€ä½¿ç”¨Shellè„šæœ¬æ¨¡æ¿ï¼ŒåŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- æœåŠ¡ç®¡ç†è„šæœ¬æ”¯æŒæ„å»ºã€å¯åŠ¨ã€åœæ­¢ã€çŠ¶æ€æ£€æŸ¥ç­‰å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- åŸºç¡€è®¾æ–½è„šæœ¬å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œå¥åº·æ£€æŸ¥
- CI/CDè„šæœ¬æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²å’Œå›æ»šæœºåˆ¶
- æ‰€æœ‰è„šæœ¬å¿…é¡»æ”¯æŒå‚æ•°éªŒè¯å’Œå¸®åŠ©ä¿¡æ¯