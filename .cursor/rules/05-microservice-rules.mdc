---
alwaysApply: true
---
# ğŸ—ï¸ å¾®æœåŠ¡è®¾è®¡å’Œæ²»ç†è§„åˆ™

## ğŸ¯ æœåŠ¡æ‹†åˆ†è§„åˆ™

### 1. æœåŠ¡è¾¹ç•Œåˆ’åˆ†
```yaml
æœåŠ¡è¾¹ç•ŒåŸåˆ™:
  ä¸šåŠ¡è¾¹ç•Œ: æŒ‰é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)åˆ’åˆ†æœåŠ¡
  æ•°æ®è¾¹ç•Œ: æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ•°æ®åº“ï¼Œé¿å…å…±äº«æ•°æ®
  å›¢é˜Ÿè¾¹ç•Œ: æœåŠ¡å¯¹åº”å¼€å‘å›¢é˜Ÿï¼Œä¾¿äºç»´æŠ¤
  æŠ€æœ¯è¾¹ç•Œ: é¿å…æŠ€æœ¯è€¦åˆï¼Œç‹¬ç«‹æŠ€æœ¯æ ˆé€‰æ‹©

å½“å‰æœåŠ¡è§„åˆ’:
  account-service:    # è´¦å·ç®¡ç†åŸŸ
    - ä¼å¾®è´¦å·CRUD
    - è´¦å·çŠ¶æ€ç®¡ç†
    - è´¦å·é…ç½®ç®¡ç†
    
  message-service:    # æ¶ˆæ¯ç®¡ç†åŸŸ  
    - æ¶ˆæ¯å‘é€
    - æ¨¡æ¿ç®¡ç†
    - å‘é€è®°å½•
    
  monitor-service:    # ç›‘æ§åŸŸ
    - æ€§èƒ½ç›‘æ§
    - å‘Šè­¦ç®¡ç†
    - ç»Ÿè®¡æŠ¥è¡¨
```

### 2. æœåŠ¡ä¾èµ–ç®¡ç†
```java
// âœ… æ­£ç¡®çš„æœåŠ¡ä¾èµ–
@FeignClient(name = "account-service", fallback = AccountServiceFallback.class)
public interface AccountServiceClient {
    
    @GetMapping("/api/v1/accounts/{id}")
    Result<AccountDTO> getAccount(@PathVariable String id);
    
    @PostMapping("/api/v1/accounts/{id}/status")
    Result<Void> updateAccountStatus(@PathVariable String id, 
                                   @RequestBody UpdateStatusRequest request);
}

// é™çº§å¤„ç†
@Component
public class AccountServiceFallback implements AccountServiceClient {
    
    @Override
    public Result<AccountDTO> getAccount(String id) {
        log.warn("è´¦å·æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼");
        return Result.error(ErrorCode.SERVICE_UNAVAILABLE, "è´¦å·æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
    }
    
    @Override
    public Result<Void> updateAccountStatus(String id, UpdateStatusRequest request) {
        log.warn("è´¦å·çŠ¶æ€æ›´æ–°å¤±è´¥ï¼Œç¨åé‡è¯•");
        // å¯ä»¥è€ƒè™‘æ”¾å…¥é‡è¯•é˜Ÿåˆ—
        return Result.error(ErrorCode.SERVICE_UNAVAILABLE, "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
    }
}
```

## ğŸ”„ æœåŠ¡é€šä¿¡è§„åˆ™

### 1. åŒæ­¥è°ƒç”¨è§„èŒƒ
```java
// âœ… æœåŠ¡é—´åŒæ­¥è°ƒç”¨
@Service
@RequiredArgsConstructor
public class MessageService {
    
    private final AccountServiceClient accountServiceClient;
    
    @HystrixCommand(fallbackMethod = "sendMessageFallback", 
                   commandProperties = {
                       @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "3000"),
                       @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10")
                   })
    public MessageSendResult sendMessage(String tenantId, SendMessageRequest request) {
        // 1. è·å–è´¦å·ä¿¡æ¯
        Result<AccountDTO> accountResult = accountServiceClient.getAccount(request.getAccountId());
        if (!accountResult.isSuccess()) {
            throw new BusinessException(ErrorCode.ACCOUNT_NOT_FOUND);
        }
        
        AccountDTO account = accountResult.getData();
        if (!AccountStatus.ONLINE.equals(account.getStatus())) {
            throw new BusinessException(ErrorCode.ACCOUNT_OFFLINE, "è´¦å·ç¦»çº¿ï¼Œæ— æ³•å‘é€æ¶ˆæ¯");
        }
        
        // 2. å‘é€æ¶ˆæ¯
        return doSendMessage(tenantId, account, request);
    }
    
    // é™çº§æ–¹æ³•
    public MessageSendResult sendMessageFallback(String tenantId, SendMessageRequest request) {
        log.warn("æ¶ˆæ¯å‘é€é™çº§å¤„ç†, tenantId={}, accountId={}", tenantId, request.getAccountId());
        return MessageSendResult.failure(ErrorCode.SERVICE_DEGRADED.getCode(), "æœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

### 2. å¼‚æ­¥é€šä¿¡è§„èŒƒ
```java
// âœ… äº‹ä»¶å‘å¸ƒ
@Service
public class AccountEventPublisher {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    public void publishAccountStatusChanged(String tenantId, String accountId, 
                                          AccountStatus oldStatus, AccountStatus newStatus) {
        AccountStatusChangedEvent event = AccountStatusChangedEvent.builder()
                .tenantId(tenantId)
                .accountId(accountId)
                .oldStatus(oldStatus)
                .newStatus(newStatus)
                .timestamp(System.currentTimeMillis())
                .build();
        
        String destination = "account-events:status-changed";
        rocketMQTemplate.asyncSend(destination, event, new SendCallback() {
            @Override
            public void onSuccess(SendResult sendResult) {
                log.debug("è´¦å·çŠ¶æ€å˜æ›´äº‹ä»¶å‘é€æˆåŠŸ, eventId={}", sendResult.getMsgId());
            }
            
            @Override
            public void onException(Throwable e) {
                log.error("è´¦å·çŠ¶æ€å˜æ›´äº‹ä»¶å‘é€å¤±è´¥, tenantId={}, accountId={}", 
                         tenantId, accountId, e);
            }
        });
    }
}

// âœ… äº‹ä»¶æ¶ˆè´¹
@Component
@RocketMQMessageListener(
    topic = "account-events",
    selectorExpression = "status-changed",
    consumerGroup = "message-service-group"
)
public class AccountStatusEventListener implements RocketMQListener<AccountStatusChangedEvent> {
    
    @Autowired
    private MessageService messageService;
    
    @Override
    public void onMessage(AccountStatusChangedEvent event) {
        try {
            // å¹‚ç­‰æ€§æ£€æŸ¥
            if (isEventProcessed(event)) {
                log.debug("äº‹ä»¶å·²å¤„ç†ï¼Œè·³è¿‡, eventId={}", event.getAccountId());
                return;
            }
            
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            handleAccountStatusChanged(event);
            
            // è®°å½•å¤„ç†çŠ¶æ€
            markEventProcessed(event);
            
        } catch (Exception e) {
            log.error("å¤„ç†è´¦å·çŠ¶æ€å˜æ›´äº‹ä»¶å¤±è´¥", e);
            throw e; // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘é‡è¯•
        }
    }
    
    private void handleAccountStatusChanged(AccountStatusChangedEvent event) {
        if (AccountStatus.OFFLINE.equals(event.getNewStatus())) {
            // è´¦å·ç¦»çº¿ï¼Œåœæ­¢ç›¸å…³æ¶ˆæ¯å‘é€ä»»åŠ¡
            messageService.pauseMessageTasks(event.getTenantId(), event.getAccountId());
        } else if (AccountStatus.ONLINE.equals(event.getNewStatus())) {
            // è´¦å·ä¸Šçº¿ï¼Œæ¢å¤æ¶ˆæ¯å‘é€ä»»åŠ¡
            messageService.resumeMessageTasks(event.getTenantId(), event.getAccountId());
        }
    }
}
```

## ğŸ›¡ï¸ æœåŠ¡æ²»ç†è§„åˆ™

### 1. æœåŠ¡æ³¨å†Œé…ç½®
```yaml
# application.yml
spring:
  application:
    name: account-service
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER:localhost:8848}
        namespace: ${NACOS_NAMESPACE:dev}
        group: ${NACOS_GROUP:DEFAULT_GROUP}
        cluster-name: ${CLUSTER_NAME:default}
        metadata:
          version: ${app.version:1.0.0}
          zone: ${app.zone:default}
          weight: 100
        heart-beat-interval: 5000
        heart-beat-timeout: 15000
        ip-delete-timeout: 30000
        
# å¥åº·æ£€æŸ¥é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      show-details: always
  health:
    defaults:
      enabled: true
    diskspace:
      enabled: true
      threshold: 10GB
    db:
      enabled: true
```

### 2. é…ç½®ç®¡ç†è§„èŒƒ
```java
// âœ… å¤–éƒ¨åŒ–é…ç½®
@Component
@ConfigurationProperties(prefix = "app.account")
@Data
@RefreshScope  // æ”¯æŒé…ç½®çƒ­æ›´æ–°
public class AccountServiceConfig {
    
    private Integer maxAccountsPerTenant = 100;
    private Integer maxRetryCount = 3;
    private Duration requestTimeout = Duration.ofSeconds(30);
    private String defaultWeWorkApiUrl = "https://qyapi.weixin.qq.com";
    
    // åŠŸèƒ½å¼€å…³
    private FeatureFlags features = new FeatureFlags();
    
    @Data
    public static class FeatureFlags {
        private boolean enableAutoRetry = true;
        private boolean enableCircuitBreaker = true;
        private boolean enableRateLimiting = true;
    }
}

// é…ç½®ä½¿ç”¨
@Service
@RequiredArgsConstructor
public class AccountService {
    
    private final AccountServiceConfig config;
    
    public void createAccount(String tenantId, CreateAccountRequest request) {
        // æ£€æŸ¥ç§Ÿæˆ·é…é¢
        int currentCount = accountMapper.countByTenantId(tenantId);
        if (currentCount >= config.getMaxAccountsPerTenant()) {
            throw new BusinessException(ErrorCode.ACCOUNT_QUOTA_EXCEEDED);
        }
        
        // å…¶ä»–ä¸šåŠ¡é€»è¾‘
    }
}
```

## ğŸ“Š æœåŠ¡ç›‘æ§è§„åˆ™

### 1. æŒ‡æ ‡ç›‘æ§
```java
// âœ… ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
@Component
@RequiredArgsConstructor
public class AccountServiceMetrics {
    
    private final MeterRegistry meterRegistry;
    
    // è®¡æ•°å™¨
    private final Counter accountCreatedCounter;
    private final Counter accountErrorCounter;
    
    // è®¡æ—¶å™¨
    private final Timer accountCreateTimer;
    
    // ä»ªè¡¨ç›˜
    private final Gauge activeAccountGauge;
    
    @PostConstruct
    public void initMetrics() {
        this.accountCreatedCounter = Counter.builder("account.created.total")
                .description("Total created accounts")
                .tag("service", "account-service")
                .register(meterRegistry);
                
        this.accountErrorCounter = Counter.builder("account.error.total")
                .description("Total account errors")
                .tag("service", "account-service")
                .register(meterRegistry);
                
        this.accountCreateTimer = Timer.builder("account.create.duration")
                .description("Account creation duration")
                .register(meterRegistry);
                
        this.activeAccountGauge = Gauge.builder("account.active.count")
                .description("Active account count")
                .register(meterRegistry, this, AccountServiceMetrics::getActiveAccountCount);
    }
    
    public void recordAccountCreated(String tenantId) {
        accountCreatedCounter.increment(Tags.of("tenant", tenantId));
    }
    
    public void recordAccountError(String tenantId, String errorType) {
        accountErrorCounter.increment(Tags.of("tenant", tenantId, "error", errorType));
    }
    
    public Timer.Sample startCreateTimer() {
        return Timer.start(meterRegistry);
    }
    
    public void recordCreateDuration(Timer.Sample sample, String tenantId) {
        sample.stop(Timer.builder("account.create.duration")
                         .tag("tenant", tenantId)
                         .register(meterRegistry));
    }
    
    private double getActiveAccountCount() {
        // è·å–æ´»è·ƒè´¦å·æ•°é‡
        return accountService.getActiveAccountCount();
    }
}
```

### 2. é“¾è·¯è¿½è¸ª
```java
// âœ… åˆ†å¸ƒå¼è¿½è¸ª
@Service
@RequiredArgsConstructor
public class MessageService {
    
    private final Tracer tracer;
    private final AccountServiceClient accountServiceClient;
    
    public MessageSendResult sendMessage(String tenantId, SendMessageRequest request) {
        Span span = tracer.nextSpan()
                .name("message-send")
                .tag("tenant.id", tenantId)
                .tag("message.type", request.getType())
                .start();
        
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span)) {
            // 1. è·å–è´¦å·ä¿¡æ¯
            Span accountSpan = tracer.nextSpan()
                    .name("get-account")
                    .tag("account.id", request.getAccountId())
                    .start();
            
            try (Tracer.SpanInScope accountWs = tracer.withSpanInScope(accountSpan)) {
                Result<AccountDTO> accountResult = accountServiceClient.getAccount(request.getAccountId());
                accountSpan.tag("account.status", accountResult.getData().getStatus().name());
            } finally {
                accountSpan.end();
            }
            
            // 2. å‘é€æ¶ˆæ¯
            MessageSendResult result = doSendMessage(tenantId, request);
            span.tag("message.id", result.getMessageId());
            span.tag("send.status", result.isSuccess() ? "success" : "failed");
            
            return result;
            
        } catch (Exception e) {
            span.tag("error", e.getMessage());
            throw e;
        } finally {
            span.end();
        }
    }
}
```

## ğŸ”„ éƒ¨ç½²å’Œæ‰©å±•è§„åˆ™

### 1. å®¹å™¨åŒ–éƒ¨ç½²
```dockerfile
# âœ… æ ‡å‡†Dockerfile
FROM openjdk:17-jdk-slim as builder

WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN ./mvnw clean package -DskipTests

FROM openjdk:17-jre-slim

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN groupadd -r appgroup && useradd -r -g appgroup appuser

WORKDIR /app

# å¤åˆ¶åº”ç”¨
COPY --from=builder /app/target/*.jar app.jar

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# åˆ‡æ¢ç”¨æˆ·
USER appuser

EXPOSE 8080

# JVMå‚æ•°ä¼˜åŒ–
ENV JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC -XX:+UseContainerSupport"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

### 2. è‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: account-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: account-service
  template:
    metadata:
      labels:
        app: account-service
    spec:
      containers:
      - name: account-service
        image: account-service:latest
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        env:
        - name: PROFILE
          value: "prod"
        - name: NACOS_ADDR
          value: "nacos:8848"
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30

---
# HPAé…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: account-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: account-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

**è§„åˆ™æ€»ç»“**:
- æŒ‰ä¸šåŠ¡åŸŸè¿›è¡ŒæœåŠ¡æ‹†åˆ†ï¼Œé¿å…æŠ€æœ¯è€¦åˆ
- æœåŠ¡é—´é€šä¿¡ä¼˜å…ˆä½¿ç”¨å¼‚æ­¥æ¶ˆæ¯ï¼Œå…³é”®è·¯å¾„åŒæ­¥è°ƒç”¨
- é…ç½®å¤–éƒ¨åŒ–ï¼Œæ”¯æŒçƒ­æ›´æ–°å’Œç¯å¢ƒéš”ç¦»
- å®Œå–„ç›‘æ§æŒ‡æ ‡å’Œé“¾è·¯è¿½è¸ª
- æ ‡å‡†åŒ–å®¹å™¨éƒ¨ç½²ï¼Œæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹# ğŸ—ï¸ å¾®æœåŠ¡è®¾è®¡å’Œæ²»ç†è§„åˆ™

## ğŸ¯ æœåŠ¡æ‹†åˆ†è§„åˆ™

### 1. æœåŠ¡è¾¹ç•Œåˆ’åˆ†
```yaml
æœåŠ¡è¾¹ç•ŒåŸåˆ™:
  ä¸šåŠ¡è¾¹ç•Œ: æŒ‰é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)åˆ’åˆ†æœåŠ¡
  æ•°æ®è¾¹ç•Œ: æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ•°æ®åº“ï¼Œé¿å…å…±äº«æ•°æ®
  å›¢é˜Ÿè¾¹ç•Œ: æœåŠ¡å¯¹åº”å¼€å‘å›¢é˜Ÿï¼Œä¾¿äºç»´æŠ¤
  æŠ€æœ¯è¾¹ç•Œ: é¿å…æŠ€æœ¯è€¦åˆï¼Œç‹¬ç«‹æŠ€æœ¯æ ˆé€‰æ‹©

å½“å‰æœåŠ¡è§„åˆ’:
  account-service:    # è´¦å·ç®¡ç†åŸŸ
    - ä¼å¾®è´¦å·CRUD
    - è´¦å·çŠ¶æ€ç®¡ç†
    - è´¦å·é…ç½®ç®¡ç†
    
  message-service:    # æ¶ˆæ¯ç®¡ç†åŸŸ  
    - æ¶ˆæ¯å‘é€
    - æ¨¡æ¿ç®¡ç†
    - å‘é€è®°å½•
    
  monitor-service:    # ç›‘æ§åŸŸ
    - æ€§èƒ½ç›‘æ§
    - å‘Šè­¦ç®¡ç†
    - ç»Ÿè®¡æŠ¥è¡¨
```

### 2. æœåŠ¡ä¾èµ–ç®¡ç†
```java
// âœ… æ­£ç¡®çš„æœåŠ¡ä¾èµ–
@FeignClient(name = "account-service", fallback = AccountServiceFallback.class)
public interface AccountServiceClient {
    
    @GetMapping("/api/v1/accounts/{id}")
    Result<AccountDTO> getAccount(@PathVariable String id);
    
    @PostMapping("/api/v1/accounts/{id}/status")
    Result<Void> updateAccountStatus(@PathVariable String id, 
                                   @RequestBody UpdateStatusRequest request);
}

// é™çº§å¤„ç†
@Component
public class AccountServiceFallback implements AccountServiceClient {
    
    @Override
    public Result<AccountDTO> getAccount(String id) {
        log.warn("è´¦å·æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼");
        return Result.error(ErrorCode.SERVICE_UNAVAILABLE, "è´¦å·æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
    }
    
    @Override
    public Result<Void> updateAccountStatus(String id, UpdateStatusRequest request) {
        log.warn("è´¦å·çŠ¶æ€æ›´æ–°å¤±è´¥ï¼Œç¨åé‡è¯•");
        // å¯ä»¥è€ƒè™‘æ”¾å…¥é‡è¯•é˜Ÿåˆ—
        return Result.error(ErrorCode.SERVICE_UNAVAILABLE, "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
    }
}
```

## ğŸ”„ æœåŠ¡é€šä¿¡è§„åˆ™

### 1. åŒæ­¥è°ƒç”¨è§„èŒƒ
```java
// âœ… æœåŠ¡é—´åŒæ­¥è°ƒç”¨
@Service
@RequiredArgsConstructor
public class MessageService {
    
    private final AccountServiceClient accountServiceClient;
    
    @HystrixCommand(fallbackMethod = "sendMessageFallback", 
                   commandProperties = {
                       @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "3000"),
                       @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10")
                   })
    public MessageSendResult sendMessage(String tenantId, SendMessageRequest request) {
        // 1. è·å–è´¦å·ä¿¡æ¯
        Result<AccountDTO> accountResult = accountServiceClient.getAccount(request.getAccountId());
        if (!accountResult.isSuccess()) {
            throw new BusinessException(ErrorCode.ACCOUNT_NOT_FOUND);
        }
        
        AccountDTO account = accountResult.getData();
        if (!AccountStatus.ONLINE.equals(account.getStatus())) {
            throw new BusinessException(ErrorCode.ACCOUNT_OFFLINE, "è´¦å·ç¦»çº¿ï¼Œæ— æ³•å‘é€æ¶ˆæ¯");
        }
        
        // 2. å‘é€æ¶ˆæ¯
        return doSendMessage(tenantId, account, request);
    }
    
    // é™çº§æ–¹æ³•
    public MessageSendResult sendMessageFallback(String tenantId, SendMessageRequest request) {
        log.warn("æ¶ˆæ¯å‘é€é™çº§å¤„ç†, tenantId={}, accountId={}", tenantId, request.getAccountId());
        return MessageSendResult.failure(ErrorCode.SERVICE_DEGRADED.getCode(), "æœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

### 2. å¼‚æ­¥é€šä¿¡è§„èŒƒ
```java
// âœ… äº‹ä»¶å‘å¸ƒ
@Service
public class AccountEventPublisher {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    public void publishAccountStatusChanged(String tenantId, String accountId, 
                                          AccountStatus oldStatus, AccountStatus newStatus) {
        AccountStatusChangedEvent event = AccountStatusChangedEvent.builder()
                .tenantId(tenantId)
                .accountId(accountId)
                .oldStatus(oldStatus)
                .newStatus(newStatus)
                .timestamp(System.currentTimeMillis())
                .build();
        
        String destination = "account-events:status-changed";
        rocketMQTemplate.asyncSend(destination, event, new SendCallback() {
            @Override
            public void onSuccess(SendResult sendResult) {
                log.debug("è´¦å·çŠ¶æ€å˜æ›´äº‹ä»¶å‘é€æˆåŠŸ, eventId={}", sendResult.getMsgId());
            }
            
            @Override
            public void onException(Throwable e) {
                log.error("è´¦å·çŠ¶æ€å˜æ›´äº‹ä»¶å‘é€å¤±è´¥, tenantId={}, accountId={}", 
                         tenantId, accountId, e);
            }
        });
    }
}

// âœ… äº‹ä»¶æ¶ˆè´¹
@Component
@RocketMQMessageListener(
    topic = "account-events",
    selectorExpression = "status-changed",
    consumerGroup = "message-service-group"
)
public class AccountStatusEventListener implements RocketMQListener<AccountStatusChangedEvent> {
    
    @Autowired
    private MessageService messageService;
    
    @Override
    public void onMessage(AccountStatusChangedEvent event) {
        try {
            // å¹‚ç­‰æ€§æ£€æŸ¥
            if (isEventProcessed(event)) {
                log.debug("äº‹ä»¶å·²å¤„ç†ï¼Œè·³è¿‡, eventId={}", event.getAccountId());
                return;
            }
            
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            handleAccountStatusChanged(event);
            
            // è®°å½•å¤„ç†çŠ¶æ€
            markEventProcessed(event);
            
        } catch (Exception e) {
            log.error("å¤„ç†è´¦å·çŠ¶æ€å˜æ›´äº‹ä»¶å¤±è´¥", e);
            throw e; // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘é‡è¯•
        }
    }
    
    private void handleAccountStatusChanged(AccountStatusChangedEvent event) {
        if (AccountStatus.OFFLINE.equals(event.getNewStatus())) {
            // è´¦å·ç¦»çº¿ï¼Œåœæ­¢ç›¸å…³æ¶ˆæ¯å‘é€ä»»åŠ¡
            messageService.pauseMessageTasks(event.getTenantId(), event.getAccountId());
        } else if (AccountStatus.ONLINE.equals(event.getNewStatus())) {
            // è´¦å·ä¸Šçº¿ï¼Œæ¢å¤æ¶ˆæ¯å‘é€ä»»åŠ¡
            messageService.resumeMessageTasks(event.getTenantId(), event.getAccountId());
        }
    }
}
```

## ğŸ›¡ï¸ æœåŠ¡æ²»ç†è§„åˆ™

### 1. æœåŠ¡æ³¨å†Œé…ç½®
```yaml
# application.yml
spring:
  application:
    name: account-service
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER:localhost:8848}
        namespace: ${NACOS_NAMESPACE:dev}
        group: ${NACOS_GROUP:DEFAULT_GROUP}
        cluster-name: ${CLUSTER_NAME:default}
        metadata:
          version: ${app.version:1.0.0}
          zone: ${app.zone:default}
          weight: 100
        heart-beat-interval: 5000
        heart-beat-timeout: 15000
        ip-delete-timeout: 30000
        
# å¥åº·æ£€æŸ¥é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      show-details: always
  health:
    defaults:
      enabled: true
    diskspace:
      enabled: true
      threshold: 10GB
    db:
      enabled: true
```

### 2. é…ç½®ç®¡ç†è§„èŒƒ
```java
// âœ… å¤–éƒ¨åŒ–é…ç½®
@Component
@ConfigurationProperties(prefix = "app.account")
@Data
@RefreshScope  // æ”¯æŒé…ç½®çƒ­æ›´æ–°
public class AccountServiceConfig {
    
    private Integer maxAccountsPerTenant = 100;
    private Integer maxRetryCount = 3;
    private Duration requestTimeout = Duration.ofSeconds(30);
    private String defaultWeWorkApiUrl = "https://qyapi.weixin.qq.com";
    
    // åŠŸèƒ½å¼€å…³
    private FeatureFlags features = new FeatureFlags();
    
    @Data
    public static class FeatureFlags {
        private boolean enableAutoRetry = true;
        private boolean enableCircuitBreaker = true;
        private boolean enableRateLimiting = true;
    }
}

// é…ç½®ä½¿ç”¨
@Service
@RequiredArgsConstructor
public class AccountService {
    
    private final AccountServiceConfig config;
    
    public void createAccount(String tenantId, CreateAccountRequest request) {
        // æ£€æŸ¥ç§Ÿæˆ·é…é¢
        int currentCount = accountMapper.countByTenantId(tenantId);
        if (currentCount >= config.getMaxAccountsPerTenant()) {
            throw new BusinessException(ErrorCode.ACCOUNT_QUOTA_EXCEEDED);
        }
        
        // å…¶ä»–ä¸šåŠ¡é€»è¾‘
    }
}
```

## ğŸ“Š æœåŠ¡ç›‘æ§è§„åˆ™

### 1. æŒ‡æ ‡ç›‘æ§
```java
// âœ… ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
@Component
@RequiredArgsConstructor
public class AccountServiceMetrics {
    
    private final MeterRegistry meterRegistry;
    
    // è®¡æ•°å™¨
    private final Counter accountCreatedCounter;
    private final Counter accountErrorCounter;
    
    // è®¡æ—¶å™¨
    private final Timer accountCreateTimer;
    
    // ä»ªè¡¨ç›˜
    private final Gauge activeAccountGauge;
    
    @PostConstruct
    public void initMetrics() {
        this.accountCreatedCounter = Counter.builder("account.created.total")
                .description("Total created accounts")
                .tag("service", "account-service")
                .register(meterRegistry);
                
        this.accountErrorCounter = Counter.builder("account.error.total")
                .description("Total account errors")
                .tag("service", "account-service")
                .register(meterRegistry);
                
        this.accountCreateTimer = Timer.builder("account.create.duration")
                .description("Account creation duration")
                .register(meterRegistry);
                
        this.activeAccountGauge = Gauge.builder("account.active.count")
                .description("Active account count")
                .register(meterRegistry, this, AccountServiceMetrics::getActiveAccountCount);
    }
    
    public void recordAccountCreated(String tenantId) {
        accountCreatedCounter.increment(Tags.of("tenant", tenantId));
    }
    
    public void recordAccountError(String tenantId, String errorType) {
        accountErrorCounter.increment(Tags.of("tenant", tenantId, "error", errorType));
    }
    
    public Timer.Sample startCreateTimer() {
        return Timer.start(meterRegistry);
    }
    
    public void recordCreateDuration(Timer.Sample sample, String tenantId) {
        sample.stop(Timer.builder("account.create.duration")
                         .tag("tenant", tenantId)
                         .register(meterRegistry));
    }
    
    private double getActiveAccountCount() {
        // è·å–æ´»è·ƒè´¦å·æ•°é‡
        return accountService.getActiveAccountCount();
    }
}
```

### 2. é“¾è·¯è¿½è¸ª
```java
// âœ… åˆ†å¸ƒå¼è¿½è¸ª
@Service
@RequiredArgsConstructor
public class MessageService {
    
    private final Tracer tracer;
    private final AccountServiceClient accountServiceClient;
    
    public MessageSendResult sendMessage(String tenantId, SendMessageRequest request) {
        Span span = tracer.nextSpan()
                .name("message-send")
                .tag("tenant.id", tenantId)
                .tag("message.type", request.getType())
                .start();
        
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span)) {
            // 1. è·å–è´¦å·ä¿¡æ¯
            Span accountSpan = tracer.nextSpan()
                    .name("get-account")
                    .tag("account.id", request.getAccountId())
                    .start();
            
            try (Tracer.SpanInScope accountWs = tracer.withSpanInScope(accountSpan)) {
                Result<AccountDTO> accountResult = accountServiceClient.getAccount(request.getAccountId());
                accountSpan.tag("account.status", accountResult.getData().getStatus().name());
            } finally {
                accountSpan.end();
            }
            
            // 2. å‘é€æ¶ˆæ¯
            MessageSendResult result = doSendMessage(tenantId, request);
            span.tag("message.id", result.getMessageId());
            span.tag("send.status", result.isSuccess() ? "success" : "failed");
            
            return result;
            
        } catch (Exception e) {
            span.tag("error", e.getMessage());
            throw e;
        } finally {
            span.end();
        }
    }
}
```

## ğŸ”„ éƒ¨ç½²å’Œæ‰©å±•è§„åˆ™

### 1. å®¹å™¨åŒ–éƒ¨ç½²
```dockerfile
# âœ… æ ‡å‡†Dockerfile
FROM openjdk:17-jdk-slim as builder

WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN ./mvnw clean package -DskipTests

FROM openjdk:17-jre-slim

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN groupadd -r appgroup && useradd -r -g appgroup appuser

WORKDIR /app

# å¤åˆ¶åº”ç”¨
COPY --from=builder /app/target/*.jar app.jar

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# åˆ‡æ¢ç”¨æˆ·
USER appuser

EXPOSE 8080

# JVMå‚æ•°ä¼˜åŒ–
ENV JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC -XX:+UseContainerSupport"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

### 2. è‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: account-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: account-service
  template:
    metadata:
      labels:
        app: account-service
    spec:
      containers:
      - name: account-service
        image: account-service:latest
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        env:
        - name: PROFILE
          value: "prod"
        - name: NACOS_ADDR
          value: "nacos:8848"
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30

---
# HPAé…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: account-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: account-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

**è§„åˆ™æ€»ç»“**:
- æŒ‰ä¸šåŠ¡åŸŸè¿›è¡ŒæœåŠ¡æ‹†åˆ†ï¼Œé¿å…æŠ€æœ¯è€¦åˆ
- æœåŠ¡é—´é€šä¿¡ä¼˜å…ˆä½¿ç”¨å¼‚æ­¥æ¶ˆæ¯ï¼Œå…³é”®è·¯å¾„åŒæ­¥è°ƒç”¨
- é…ç½®å¤–éƒ¨åŒ–ï¼Œæ”¯æŒçƒ­æ›´æ–°å’Œç¯å¢ƒéš”ç¦»
- å®Œå–„ç›‘æ§æŒ‡æ ‡å’Œé“¾è·¯è¿½è¸ª
- æ ‡å‡†åŒ–å®¹å™¨éƒ¨ç½²ï¼Œæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹